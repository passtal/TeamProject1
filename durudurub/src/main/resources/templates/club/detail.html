<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/main_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${club != null ? club.title + ' - 두루두룹' : '모임 상세보기 - 두루두룹'}">모임 상세보기</title>
    <link rel="stylesheet" th:href="@{/css/board/board.css}">
</head>

<body layout:fragment="content" class="board-detail-page">

    <th:block th:if="${club != null}">
    <div class="hero-section">
        <div class="hero-image-wrapper">
            <img th:src="${club.thumbnailImg != null ? club.thumbnailImg : '/img/board/hero-image.png'}" alt="모임 대표 이미지">
        </div>
    </div>

    <div class="container board-container">
        <div class="board-card">
            <div class="board-header">
                <div class="header-top">
                    <h1 class="board-title" th:text="${club.title}">독서 모임</h1>
                    <button class="btn-heart" id="btnClubLike" th:data-no="${club.no}" th:classappend="${club.liked ? 'liked' : ''}">
                        <img th:src="@{/img/board/heart-icon.png}" alt="좋아요">
                        <span class="heart-badge" th:text="${club.likeCount}">42</span>
                    </button>
                </div>

                <div class="board-meta">
                    <div class="category-badge" th:text="${club.category != null ? club.category.name : '미분류'}">책</div>
                    <div class="leader-info">
                        <span class="meta-label">리더</span>
                        <span class="meta-value" th:text="${club.host != null ? club.host.username : '알 수 없음'}">리더</span>
                    </div>
                </div>

                <div class="board-actions">
                    <div class="member-status">
                        <img th:src="@{/img/board/member-icon.png}" alt="멤버">
                        <span th:text="${club.currentMembers} + '/' + ${club.maxMembers} + '명 참여 중'">참여 중</span>
                    </div>
                    <button th:if="${isHost}" class="btn btn-edit" onclick="editClubInfo()">
                        <img th:src="@{/img/board/edit-icon.png}" alt="편집">
                        정보 수정
                    </button>
                    <a th:if="${myMembership == null and !isHost}" th:href="@{/club/{no}/join(no=${club.no})}" class="btn btn-join">모임 가입하기</a>
                    <span th:if="${myMembership != null and !isHost}" class="badge bg-success">참여 중</span>
                </div>
            </div>

            <div class="board-content">
                <div class="content-section">
                    <h2 class="section-title">모임 소개</h2>
                    <div class="section-text" th:utext="${club.description}">모임 설명</div>
                </div>

                <div class="content-section schedule-location">
                    <div class="schedule-section">
                        <div class="schedule-header">
                            <h2 class="section-title">모임 일시</h2>
                        </div>
                        <div class="schedule-list">
                            <div class="schedule-item active" th:if="${club.clubDate != null}">
                                <div class="schedule-content">
                                    <img th:src="@{/img/board/calendar-icon.png}" alt="달력">
                                    <span th:text="${club.clubDate}">날짜</span>
                                </div>
                            </div>
                            <div class="schedule-item" th:if="${club.deadLine != null}">
                                <div class="schedule-content">
                                    <img th:src="@{/img/board/calendar-icon.png}" alt="마감일">
                                    <span>모집 마감: <span th:text="${club.deadLine}"></span></span>
                                </div>
                            </div>
                            <p th:if="${club.clubDate == null}" class="text-muted">일정이 아직 정해지지 않았습니다.</p>
                        </div>
                    </div>

                    <div class="location-section">
                        <div class="location-header">
                            <img th:src="@{/img/board/location-icon.png}" alt="장소">
                            <div class="location-info">
                                <span class="location-label">장소</span>
                                <span class="location-value" th:text="${club.location != null ? club.location : '미정'}">장소</span>
                            </div>
                        </div>
                        <div id="map" class="map-container" th:if="${club.lat != null and club.lng != null}"></div>
                        <p th:if="${club.lat == null or club.lng == null}" class="text-muted mt-2">지도 위치가 설정되지 않았습니다.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="members-section mt-4">
            <h2 class="section-title">멤버 목록 (<span th:text="${club.currentMembers}">0</span>명)</h2>
            <div class="member-list d-flex flex-wrap gap-3 mt-3">
                <th:block th:each="member : ${members}">
                    <div th:if="${member.user != null}" class="member-item d-flex align-items-center gap-2 p-2 bg-light rounded">
                        <div class="member-avatar" th:text="${member.user.username != null ? #strings.substring(member.user.username, 0, 1) : '?'}">김</div>
                        <div class="member-info">
                            <span class="member-name" th:text="${member.user.username != null ? member.user.username : '알 수 없음'}">멤버</span>
                            <span th:if="${member.userNo == club.hostNo}" class="badge bg-primary ms-1">호스트</span>
                        </div>
                    </div>
                </th:block>
            </div>
        </div>

        <div class="posts-section mt-5">
            <div class="posts-header d-flex justify-content-between align-items-center mb-4">
                <h2 class="section-title mb-0">게시글</h2>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted"><i class="bi bi-chat-square-text"></i> 멤버만 작성 가능</span>
                    <a th:if="${myMembership != null or isHost}" th:href="@{/club/{no}/board/create(no=${club.no})}" class="btn btn-primary btn-sm">
                        <i class="bi bi-pencil"></i> 글쓰기
                    </a>
                </div>
            </div>

            <div class="posts-list">
                <th:block th:if="${boards != null and !boards.empty}">
                    <th:block th:each="board : ${boards}">
                        <a th:href="@{/club/{clubNo}/board/{no}(clubNo=${club.no}, no=${board.no})}" class="post-card mb-4 p-4 bg-white rounded-3 shadow-sm d-block text-decoration-none text-dark">
                            <div class="post-header d-flex align-items-center gap-3 mb-3">
                                <div class="post-avatar" th:text="${board.writer != null and board.writer.username != null ? #strings.substring(board.writer.username, 0, 1) : '?'}">김</div>
                                <div class="post-meta">
                                    <span class="post-author fw-bold" th:text="${board.writer != null ? board.writer.username : '알 수 없음'}">작성자</span>
                                    <span class="post-date text-muted ms-2" th:if="${board.createdAt != null}" th:text="${board.createdAt}">날짜</span>
                                </div>
                            </div>
                            <h5 class="post-title mb-2" th:text="${board.title}">게시글 제목</h5>
                            <div class="post-content mb-3" th:if="${board.content != null}">
                                <p class="mb-2 text-muted" th:text="${#strings.abbreviate(board.content, 100)}">내용</p>
                            </div>
                            <div class="post-actions d-flex gap-4">
                                <span class="text-muted d-flex align-items-center gap-1">
                                    <i class="bi bi-hand-thumbs-up"></i>
                                    <span th:text="${board.likeCount != null ? board.likeCount : 0}">0</span>
                                </span>
                                <span class="text-muted d-flex align-items-center gap-1">
                                    <i class="bi bi-chat"></i>
                                    <span th:text="${board.commentCount != null ? board.commentCount : 0}">0</span> 댓글
                                </span>
                            </div>
                        </a>
                    </th:block>
                </th:block>
                
                <div th:if="${boards == null or boards.empty}" class="text-center py-5 text-muted">
                    <i class="bi bi-chat-square-text fs-1"></i>
                    <p class="mt-3">아직 게시글이 없습니다.</p>
                    <a th:if="${myMembership != null or isHost}" th:href="@{/club/{no}/board/create(no=${club.no})}" class="btn btn-outline-primary">첫 게시글 작성하기</a>
                </div>
            </div>
            
            <div th:if="${boards != null and !boards.empty}" class="text-center mt-4">
                <a th:href="@{/club/{no}/board(no=${club.no})}" class="btn btn-outline-secondary">
                    게시글 더보기 <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    
    <!-- 모달은 나중에 추가 -->
    </th:block>

    <th:block th:if="${club == null}">
        <div class="container mt-5">
            <div class="alert alert-warning">모임 정보를 찾을 수 없습니다.</div>
            <a href="/club/list" class="btn btn-primary">모임 목록으로 돌아가기</a>
        </div>
    </th:block>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script th:if="${club != null and club.lat != null and club.lng != null}" th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            var clubLat = /*[[${club.lat}]]*/ 37.5;
            var clubLng = /*[[${club.lng}]]*/ 127.0;
            var clubLocation = /*[[${club.location}]]*/ '모임 장소';
            
            if (clubLat && clubLng && document.getElementById('map')) {
                var map = L.map('map').setView([clubLat, clubLng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                L.marker([clubLat, clubLng]).addTo(map).bindPopup(clubLocation).openPopup();
                setTimeout(function() { map.invalidateSize(); }, 100);
            }
        });
    </script>
    
    <script th:if="${club != null}" th:inline="javascript">
        var clubNo = /*[[${club.no}]]*/ 0;
        
        $('#btnClubLike').click(function() {
            var btn = $(this);
            $.ajax({
                url: '/api/likes/club/' + clubNo,
                type: 'POST',
                success: function(result) {
                    btn.find('.heart-badge').text(result.count);
                    btn.toggleClass('liked', result.liked);
                },
                error: function() {
                    alert('로그인이 필요합니다.');
                }
            });
        });
    </script>
</body>
</html>
