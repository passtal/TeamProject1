<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/main_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${club.title} + ' - ë‘ë£¨ë‘ë£¹'">ëª¨ì„ ìƒì„¸ë³´ê¸°</title>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/club-detail.css}">
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body layout:fragment="content" class="board-detail-page">

    <div class="hero-section">
        <div class="hero-image-wrapper">
            <img th:src="${club.thumbnailImg != null ? club.thumbnailImg : '/img/board/hero-image.png'}" alt="ëª¨ì„ ëŒ€í‘œ ì´ë¯¸ì§€">
        </div>
    </div>

    <div class="container board-container">
        <div class="board-card">
            <div class="board-header">
                <div class="header-top">
                    <h1 class="board-title" th:text="${club.title}">ë…ì„œ ëª¨ì„ - ë§¤ì£¼ í•œ ê¶Œ ì™„ë…í•˜ê¸°</h1>
                    <button class="btn-heart" id="btnClubLike" th:data-no="${club.no}" th:classappend="${club.liked ? 'liked' : ''}">
                        <img th:src="@{/img/board/heart-icon.png}" alt="ì¢‹ì•„ìš”">
                        <span class="heart-badge" th:text="${club.likeCount}">42</span>
                    </button>
                </div>

                <div class="board-meta">
                    <div class="category-badge" th:text="${club.category.name}">ì±…</div>
                    <div class="leader-info">
                        <span class="meta-label">ë¦¬ë”</span>
                        <span class="meta-value" th:text="${club.host.username}">ì±…ë²Œë ˆ</span>
                    </div>
                </div>

                <!-- Member & Join Button -->
                <div class="board-actions">
                    <div class="member-status">
                        <img th:src="@{/img/board/member-icon.png}" alt="ë©¤ë²„">
                        <span th:text="${club.currentMembers} + '/' + ${club.maxMembers} + 'ëª… ì°¸ì—¬ ì¤‘'">12/15ëª… ì°¸ì—¬ ì¤‘</span>
                    </div>
                    <!-- í˜¸ìŠ¤íŠ¸ì¸ ê²½ìš° ì •ë³´ ìˆ˜ì • ë²„íŠ¼ -->
                    <button th:if="${isHost}" class="btn btn-edit" onclick="editClubInfo()">
                        <img th:src="@{/img/board/edit-icon.png}" alt="í¸ì§‘">
                        ì •ë³´ ìˆ˜ì •
                    </button>
                    <!-- í˜¸ìŠ¤íŠ¸ê°€ ì•„ë‹ˆê³ , ì•„ì§ ê°€ì…í•˜ì§€ ì•Šì€ ê²½ìš° ê°€ì…í•˜ê¸° ë²„íŠ¼ -->
                    <a th:if="${myMembership == null and !isHost}" th:href="@{/club/{no}/join(no=${club.no})}" class="btn btn-join">ëª¨ì„ ê°€ì…í•˜ê¸°</a>
                    <!-- ì´ë¯¸ ê°€ì…í•œ ê²½ìš° -->
                    <span th:if="${myMembership != null and !isHost}" class="badge bg-success">ì°¸ì—¬ ì¤‘</span>
                </div>
            </div>

            <!-- Content Section -->
            <div class="board-content">
                <!-- Introduction -->
                <div class="content-section">
                    <h2 class="section-title">ëª¨ì„ ì†Œê°œ</h2>
                    <div class="section-text" th:utext="${club.description}">ëª¨ì„ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>

                <!-- Schedule & Location -->
                <div class="content-section schedule-location">
                    <!-- Schedule -->
                    <div class="schedule-section">
                        <div class="schedule-header">
                            <h2 class="section-title">ëª¨ì„ ì¼ì‹œ</h2>
                        </div>
                        <div class="schedule-list">
                            <div class="schedule-item active" th:if="${club.clubDate != null}">
                                <div class="schedule-content">
                                    <img th:src="@{/img/board/calendar-icon.png}" alt="ë‹¬ë ¥">
                                    <span th:text="${#temporals.format(club.clubDate, 'yyyyë…„ Mì›” dì¼ (E) a h:mm')}">2ì›” 1ì¼ (ì¼) ì˜¤ì „ 9:00</span>
                                </div>
                            </div>
                            <div class="schedule-item" th:if="${club.deadLine != null}">
                                <div class="schedule-content">
                                    <img th:src="@{/img/board/calendar-icon.png}" alt="ë§ˆê°ì¼">
                                    <span>ëª¨ì§‘ ë§ˆê°: <span th:text="${#temporals.format(club.deadLine, 'yyyyë…„ Mì›” dì¼')}"></span></span>
                                </div>
                            </div>
                            <p th:if="${club.clubDate == null}" class="text-muted">ì¼ì •ì´ ì•„ì§ ì •í•´ì§€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="location-section">
                        <div class="location-header">
                            <img th:src="@{/img/board/location-icon.png}" alt="ì¥ì†Œ">
                            <div class="location-info">
                                <span class="location-label">ì¥ì†Œ</span>
                                <span class="location-value" th:text="${club.location ?: 'ë¯¸ì •'}">ê°•ë‚¨êµ¬</span>
                            </div>
                        </div>
                        <!-- Map Container -->
                        <div id="map" class="map-container" th:if="${club.lat != null and club.lng != null}"></div>
                        <p th:if="${club.lat == null or club.lng == null}" class="text-muted mt-2">ì§€ë„ ìœ„ì¹˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Members Section -->
        <div class="members-section mt-4">
            <h2 class="section-title">ë©¤ë²„ ëª©ë¡ (<span th:text="${club.currentMembers}">0</span>ëª…)</h2>
            <div class="member-list d-flex flex-wrap gap-3 mt-3">
                <div th:each="member : ${members}" class="member-item d-flex align-items-center gap-2 p-2 bg-light rounded">
                    <div class="member-avatar" th:text="${#strings.substring(member.user.username, 0, 1)}">ê¹€</div>
                    <div class="member-info">
                        <span class="member-name" th:text="${member.user.username}">ë©¤ë²„ì´ë¦„</span>
                        <span th:if="${member.role == 'HOST'}" class="badge bg-primary ms-1">í˜¸ìŠ¤íŠ¸</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê²Œì‹œíŒ ë§í¬ -->
        <div class="board-link-section mt-4">
            <a th:href="@{/club/{no}/board(no=${club.no})}" class="btn btn-outline-primary btn-lg w-100">
                ğŸ“‹ ê²Œì‹œíŒ ë°”ë¡œê°€ê¸°
            </a>
        </div>
    </div>
    

    <!-- í˜¸ìŠ¤íŠ¸ ì „ìš© ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
    <div th:if="${isHost}" class="modal fade" id="editClubModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content edit-modal">
                <!-- Modal Header -->
                <div class="modal-header edit-modal-header">
                    <h2 class="modal-title">ëª¨ì„ ì •ë³´ ìˆ˜ì •</h2>
                    <button type="button" class="btn-close-modal" data-bs-dismiss="modal" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M18 6L6 18M6 6L18 18" stroke="#99A1AF" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body edit-modal-body">
                    <form id="editClubForm">
                        <!-- ëª¨ì„ ì œëª© -->
                        <div class="form-group mb-3">
                            <label for="clubTitle" class="form-label">ëª¨ì„ ì œëª©</label>
                            <input type="text" class="form-control" id="clubTitle" th:value="${club.title}" placeholder="ëª¨ì„ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>

                        <!-- ëª¨ì„ ì„¤ëª… -->
                        <div class="form-group mb-3">
                            <label for="clubDescription" class="form-label">ëª¨ì„ ì„¤ëª…</label>
                            <textarea class="form-control" id="clubDescription" rows="4" th:text="${club.description}" placeholder="ëª¨ì„ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>

                        <!-- ìµœëŒ€ ì¸ì› -->
                        <div class="form-group mb-3">
                            <label for="maxMembers" class="form-label">ìµœëŒ€ ì¸ì›</label>
                            <input type="number" class="form-control" id="maxMembers" th:value="${club.maxMembers}" min="1" placeholder="20">
                        </div>

                        <!-- ëª¨ì„ ì¥ì†Œ -->
                        <div class="form-group mb-3">
                            <label for="clubLocation" class="form-label">ëª¨ì„ ì¥ì†Œ</label>
                            <input type="text" class="form-control" id="clubLocation" th:value="${club.location}" placeholder="ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 152">
                        </div>

                        <!-- ìœ„ë„/ê²½ë„ -->
                        <div class="form-group mb-3">
                            <label class="form-label">ì¢Œí‘œ (ì„ íƒ)</label>
                            <div class="d-flex gap-2">
                                <input type="number" step="0.00000001" class="form-control" id="clubLat" th:value="${club.lat}" placeholder="ìœ„ë„ (ì˜ˆ: 37.5172)">
                                <input type="number" step="0.00000001" class="form-control" id="clubLng" th:value="${club.lng}" placeholder="ê²½ë„ (ì˜ˆ: 127.0473)">
                            </div>
                        </div>

                        <!-- ëª¨ì„ ì¼ì‹œ -->
                        <div class="form-group mb-3">
                            <label for="clubDate" class="form-label">ëª¨ì„ ì¼ì‹œ</label>
                            <input type="datetime-local" class="form-control" id="clubDate" 
                                   th:value="${club.clubDate != null ? #temporals.format(club.clubDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
                        </div>

                        <!-- ëª¨ì§‘ ë§ˆê°ì¼ -->
                        <div class="form-group mb-3">
                            <label for="clubDeadline" class="form-label">ëª¨ì§‘ ë§ˆê°ì¼</label>
                            <input type="date" class="form-control" id="clubDeadline" 
                                   th:value="${club.deadLine != null ? #temporals.format(club.deadLine, 'yyyy-MM-dd') : ''}">
                        </div>
                    </form>
                </div>

                <div class="modal-footer edit-modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="saveClubInfo()">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script th:inline="javascript">
        const clubNo = [[${club.no}]];
        const clubLat = [[${club.lat}]];
        const clubLng = [[${club.lng}]];
        const clubLocation = [[${club.location}]];
        
        // Initialize Map
        document.addEventListener('DOMContentLoaded', function() {
            // ì¢Œí‘œê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì§€ë„ ì´ˆê¸°í™”
            if (clubLat && clubLng) {
                const map = L.map('map').setView([clubLat, clubLng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

                // ë§ˆì»¤ ì¶”ê°€
                L.marker([clubLat, clubLng]).addTo(map)
                    .bindPopup(clubLocation || 'ëª¨ì„ ì¥ì†Œ')
                    .openPopup();
            }
        });

        // ëª¨ì„ ì¢‹ì•„ìš” í† ê¸€ (ë¹„ë™ê¸°)
        $('#btnClubLike').click(function() {
            const btn = $(this);
            $.ajax({
                url: '/api/likes/club/' + clubNo,
                type: 'POST',
                success: function(result) {
                    btn.find('.heart-badge').text(result.count);
                    btn.toggleClass('liked', result.liked);
                },
                error: function() {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                }
            });
        });

        // í˜¸ìŠ¤íŠ¸ ê¸°ëŠ¥: ëª¨ì„ ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function editClubInfo() {
            const modal = new bootstrap.Modal(document.getElementById('editClubModal'));
            modal.show();
        }

        // í˜¸ìŠ¤íŠ¸ ê¸°ëŠ¥: ëª¨ì„ ì •ë³´ ì €ì¥ (ë¹„ë™ê¸°)
        function saveClubInfo() {
            const data = {
                no: clubNo,
                title: document.getElementById('clubTitle').value,
                description: document.getElementById('clubDescription').value,
                maxMembers: document.getElementById('maxMembers').value,
                location: document.getElementById('clubLocation').value,
                lat: document.getElementById('clubLat').value || null,
                lng: document.getElementById('clubLng').value || null,
                clubDate: document.getElementById('clubDate').value || null,
                deadLine: document.getElementById('clubDeadline').value || null
            };
            
            $.ajax({
                url: '/api/clubs/' + clubNo,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(result) {
                    alert('ëª¨ì„ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                },
                error: function() {
                    alert('ëª¨ì„ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
    </script>
</body>
</html>
