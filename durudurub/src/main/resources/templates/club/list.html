<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/main_layout}">

      <!-- ì„ì‹œ css -->
       <!-- <link rel="stylesheet" href="../../static/css/list.css"> -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ì„ ë‘˜ëŸ¬ë³´ê¸° - ë‘ë£¨ë‘ë£¹</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/category/list.css}">
    </th:block>
</head>
<body>
    <main layout:fragment="content">
        <!-- ëª¨ì„ íƒìƒ‰ í˜ì´ì§€ -->
        <section class="explore-page">
            <div class="explore-container">
                <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
                <div class="category-filter">
                    <!-- ì „ì²´ ë²„íŠ¼ -->
                    <button class="filter-btn active" data-category="all" data-type="all">
                        <span class="emoji">ğŸ”</span>
                        <span>ì „ì²´</span>
                    </button>
                    
                    <button th:each="category : ${categories}" 
                            class="filter-btn" 
                            th:data-category="${category.name}"
                            th:data-category-no="${category.no}"
                            data-type="main">
                        <span class="emoji" th:text="${category.icon != null ? category.icon : 'ğŸ“'}">ğŸ“š</span>
                        <span th:text="${category.name}">ì¹´í…Œê³ ë¦¬</span>
                    </button>
                </div>
                
                <!-- ì†Œë¶„ë¥˜ ì¹´í…Œê³ ë¦¬ í•„í„° (ë™ì  ìƒì„±) -->
                <div class="subcategory-filter" id="subcategory-filter" style="display: none; margin-top: 1rem;">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
                
                <!-- ê²°ê³¼ ì¹´ìš´íŠ¸ -->
                <p class="result-count">
                    <span id="club-count" th:text="${#lists.size(clubs)}">0</span>ê°œì˜ ëª¨ì„ (ìµœì‹ ìˆœ)
                </p>
                
                <!-- ëª¨ì„ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
                <div class="club-grid" id="club-grid">
                    <a th:each="club : ${clubs}" 
                       th:href="@{/club/detail/{no}(no=${club.no})}" 
                       class="club-card" 
                       th:data-category="${club.categoryName}">
                        <div class="club-card-image">
                            <img th:src="${club.thumbnailImg != null ? club.thumbnailImg : 'https://images.unsplash.com/photo-1552674605-db6ffd4facb5?w=400&h=192&fit=crop'}" 
                                 th:alt="${club.title}"
                                 onerror="this.src='https://images.unsplash.com/photo-1552674605-db6ffd4facb5?w=400&h=192&fit=crop'">
                            <button class="like-btn" onclick="toggleLike(event, this)">
                                <svg viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 17.5L8.825 16.45C4.4 12.525 1.5 10.025 1.5 7C1.5 4.5 3.5 2.5 6 2.5C7.36 2.5 8.67 3.09 9.5 4.04C10.33 3.09 11.64 2.5 13 2.5C15.5 2.5 17.5 4.5 17.5 7C17.5 10.025 14.6 12.525 10.175 16.45L10 17.5Z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="club-card-content">
                            <div class="club-card-header">
                                <span class="club-category" th:text="${club.categoryName}">ì¹´í…Œê³ ë¦¬</span>
                                <div class="club-members">
                                    <svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 8C9.66 8 11 6.66 11 5C11 3.34 9.66 2 8 2C6.34 2 5 3.34 5 5C5 6.66 6.34 8 8 8ZM8 9.5C5.83 9.5 1.5 10.59 1.5 12.75V14H14.5V12.75C14.5 10.59 10.17 9.5 8 9.5Z"/>
                                    </svg>
                                    <span th:text="${club.currentMembers} + '/' + ${club.maxMembers}">0/0</span>
                                </div>
                            </div>
                            <h3 class="club-title" th:text="${club.title}">ëª¨ì„ ì œëª©</h3>
                            <p class="club-description" th:text="${club.description}">ëª¨ì„ ì„¤ëª…</p>
                            <div class="club-location">
                                <svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 2C5.79 2 4 3.79 4 6C4 9 8 14 8 14C8 14 12 9 12 6C12 3.79 10.21 2 8 2ZM8 7.5C7.17 7.5 6.5 6.83 6.5 6C6.5 5.17 7.17 4.5 8 4.5C8.83 4.5 9.5 5.17 9.5 6C9.5 6.83 8.83 7.5 8 7.5Z"/>
                                </svg>
                                <span th:text="${club.location}">ìœ„ì¹˜</span>
                            </div>
                            <div class="club-creator">
                                <div class="creator-avatar" th:text="${#strings.substring(club.hostName, 0, 1)}">í˜¸</div>
                                <span class="creator-name" th:text="${club.hostName}">í˜¸ìŠ¤íŠ¸</span>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- í•„í„°ë§ ê²°ê³¼ ì—†ì„ ë•Œ -->
                <div class="empty-state" id="empty-state" style="display: none;">
                    <div class="empty-state-icon">ğŸ”</div>
                    <h3>í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ì„ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”</p>
                </div>
            </div>
        </section>
    </main>
    
    <th:block layout:fragment="script">
        <script th:inline="javascript">
            let allClubs = []; // ì „ì²´ ëª¨ì„ ë°ì´í„° ì €ì¥
            
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Club list page loaded');
                
                // ì´ˆê¸° ëª¨ì„ ë°ì´í„° ì €ì¥
                allClubs = Array.from(document.querySelectorAll('.club-card')).map(card => ({
                    element: card,
                    category: card.getAttribute('data-category')
                }));
                
                // ëŒ€ë¶„ë¥˜ ì¹´í…Œê³ ë¦¬ í•„í„° ê¸°ëŠ¥
                const filterButtons = document.querySelectorAll('.category-filter .filter-btn');
                console.log('Filter buttons found:', filterButtons.length);
                
                filterButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const type = this.getAttribute('data-type');
                        const categoryNo = this.getAttribute('data-category-no');
                        const category = this.getAttribute('data-category');
                        
                        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        
                        if (type === 'all') {
                            // ì „ì²´ ë³´ê¸°
                            hideSubCategories();
                            showAllClubs();
                        } else if (type === 'main' && categoryNo) {
                            // ëŒ€ë¶„ë¥˜ ì„ íƒ - ì†Œë¶„ë¥˜ ë¡œë“œ
                            loadSubCategories(categoryNo, category);
                        } else {
                            // ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°
                            hideSubCategories();
                            filterClubs(category);
                        }
                    });
                });
            });
            
            // ì†Œë¶„ë¥˜ ì¹´í…Œê³ ë¦¬ ë¡œë“œ
            function loadSubCategories(categoryNo, categoryName) {
                fetch(`/club/api/subcategories/${categoryNo}`)
                    .then(response => response.json())
                    .then(subCategories => {
                        const subCategoryFilter = document.getElementById('subcategory-filter');
                        
                        if (subCategories && subCategories.length > 0) {
                            // ì†Œë¶„ë¥˜ ë²„íŠ¼ ìƒì„±
                            let html = '<button class="filter-btn sub-btn active" data-category-no="' + categoryNo + '" data-type="main-all">'
                                     + '<span class="emoji">ğŸ“‚</span>'
                                     + '<span>' + categoryName + ' ì „ì²´</span>'
                                     + '</button>';
                            
                            subCategories.forEach(sub => {
                                html += '<button class="filter-btn sub-btn" data-sub-no="' + sub.no + '" data-type="sub">'
                                      + '<span class="emoji">ğŸ“„</span>'
                                      + '<span>' + sub.name + '</span>'
                                      + '</button>';
                            });
                            
                            subCategoryFilter.innerHTML = html;
                            subCategoryFilter.style.display = 'flex';
                            
                            // ì†Œë¶„ë¥˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
                            const subButtons = subCategoryFilter.querySelectorAll('.sub-btn');
                            subButtons.forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const type = this.getAttribute('data-type');
                                    const subNo = this.getAttribute('data-sub-no');
                                    const catNo = this.getAttribute('data-category-no');
                                    
                                    // ì†Œë¶„ë¥˜ ë²„íŠ¼ í™œì„±í™”
                                    subButtons.forEach(b => b.classList.remove('active'));
                                    this.classList.add('active');
                                    
                                    if (type === 'main-all') {
                                        loadClubsByCategory(catNo);
                                    } else if (type === 'sub') {
                                        loadClubsBySubCategory(subNo);
                                    }
                                });
                            });
                            
                            // ëŒ€ë¶„ë¥˜ ì „ì²´ ëª¨ì„ ë¡œë“œ
                            loadClubsByCategory(categoryNo);
                        } else {
                            // ì†Œë¶„ë¥˜ê°€ ì—†ìœ¼ë©´ ëŒ€ë¶„ë¥˜ë¡œ í•„í„°ë§
                            hideSubCategories();
                            loadClubsByCategory(categoryNo);
                        }
                    })
                    .catch(error => {
                        console.error('ì†Œë¶„ë¥˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                        hideSubCategories();
                        loadClubsByCategory(categoryNo);
                    });
            }
            
            // ëŒ€ë¶„ë¥˜ë³„ ëª¨ì„ ë¡œë“œ
            function loadClubsByCategory(categoryNo) {
                fetch(`/club/api/clubs/category/${categoryNo}`)
                    .then(response => response.json())
                    .then(clubs => {
                        renderClubs(clubs);
                    })
                    .catch(error => {
                        console.error('ëª¨ì„ ë¡œë“œ ì‹¤íŒ¨:', error);
                        updateEmptyState(0);
                    });
            }
            
            // ì†Œë¶„ë¥˜ë³„ ëª¨ì„ ë¡œë“œ
            function loadClubsBySubCategory(subCategoryNo) {
                fetch(`/club/api/clubs/sub/${subCategoryNo}`)
                    .then(response => response.json())
                    .then(clubs => {
                        renderClubs(clubs);
                    })
                    .catch(error => {
                        console.error('ëª¨ì„ ë¡œë“œ ì‹¤íŒ¨:', error);
                        updateEmptyState(0);
                    });
            }
            
            // ëª¨ì„ ë Œë”ë§
            function renderClubs(clubs) {
                const clubGrid = document.getElementById('club-grid');
                
                if (!clubs || clubs.length === 0) {
                    clubGrid.innerHTML = '';
                    updateEmptyState(0);
                    return;
                }
                
                let html = '';
                clubs.forEach(club => {
                    const thumbnailImg = club.thumbnailImg || 'https://images.unsplash.com/photo-1552674605-db6ffd4facb5?w=400&h=192&fit=crop';
                    const hostInitial = club.hostName ? club.hostName.charAt(0) : 'í˜¸';
                    
                    html += `
                        <a href="/club/detail/${club.no}" class="club-card" data-category="${club.categoryName}">
                            <div class="club-card-image">
                                <img src="${thumbnailImg}" alt="${club.title}" 
                                     onerror="this.src='https://images.unsplash.com/photo-1552674605-db6ffd4facb5?w=400&h=192&fit=crop'">
                                <button class="like-btn" onclick="toggleLike(event, this)">
                                    <svg viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M10 17.5L8.825 16.45C4.4 12.525 1.5 10.025 1.5 7C1.5 4.5 3.5 2.5 6 2.5C7.36 2.5 8.67 3.09 9.5 4.04C10.33 3.09 11.64 2.5 13 2.5C15.5 2.5 17.5 4.5 17.5 7C17.5 10.025 14.6 12.525 10.175 16.45L10 17.5Z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="club-card-content">
                                <div class="club-card-header">
                                    <span class="club-category">${club.categoryName}</span>
                                    <div class="club-members">
                                        <svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M8 8C9.66 8 11 6.66 11 5C11 3.34 9.66 2 8 2C6.34 2 5 3.34 5 5C5 6.66 6.34 8 8 8ZM8 9.5C5.83 9.5 1.5 10.59 1.5 12.75V14H14.5V12.75C14.5 10.59 10.17 9.5 8 9.5Z"/>
                                        </svg>
                                        <span>${club.currentMembers}/${club.maxMembers}</span>
                                    </div>
                                </div>
                                <h3 class="club-title">${club.title}</h3>
                                <p class="club-description">${club.description || ''}</p>
                                <div class="club-location">
                                    <svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 2C5.79 2 4 3.79 4 6C4 9 8 14 8 14C8 14 12 9 12 6C12 3.79 10.21 2 8 2ZM8 7.5C7.17 7.5 6.5 6.83 6.5 6C6.5 5.17 7.17 4.5 8 4.5C8.83 4.5 9.5 5.17 9.5 6C9.5 6.83 8.83 7.5 8 7.5Z"/>
                                    </svg>
                                    <span>${club.location}</span>
                                </div>
                                <div class="club-creator">
                                    <div class="creator-avatar">${hostInitial}</div>
                                    <span class="creator-name">${club.hostName}</span>
                                </div>
                            </div>
                        </a>
                    `;
                });
                
                clubGrid.innerHTML = html;
                updateEmptyState(clubs.length);
            }
            
            // ì†Œë¶„ë¥˜ ìˆ¨ê¸°ê¸°
            function hideSubCategories() {
                const subCategoryFilter = document.getElementById('subcategory-filter');
                subCategoryFilter.style.display = 'none';
                subCategoryFilter.innerHTML = '';
            }
            
            // ì „ì²´ ëª¨ì„ í‘œì‹œ
            function showAllClubs() {
                const cards = document.querySelectorAll('.club-card');
                cards.forEach(card => card.style.display = '');
                updateEmptyState(cards.length);
            }
            
            // ë¹ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
            function updateEmptyState(count) {
                document.getElementById('club-count').textContent = count;
                
                const emptyState = document.getElementById('empty-state');
                const clubGrid = document.getElementById('club-grid');
                
                if (count === 0) {
                    emptyState.style.display = 'block';
                    clubGrid.style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    clubGrid.style.display = '';
                }
            }
            
            function filterClubs(category) {
                const cards = document.querySelectorAll('.club-card');
                let visibleCount = 0;
                
                console.log('Filtering by category:', category);
                console.log('Total cards:', cards.length);
                
                if (category === 'all') {
                    cards.forEach(card => {
                        card.style.display = '';
                        visibleCount++;
                    });
                } else {
                    cards.forEach(card => {
                        const cardCategory = card.getAttribute('data-category');
                        console.log('Card category:', cardCategory, 'Match:', cardCategory === category);
                        
                        if (cardCategory === category) {
                            card.style.display = '';
                            visibleCount++;
                        } else {
                            card.style.display = 'none';
                        }
                    });
                }
                
                updateEmptyState(visibleCount);
            }
            
            // ì¢‹ì•„ìš” í† ê¸€
            function toggleLike(event, button) {
                event.preventDefault();
                event.stopPropagation();
                button.classList.toggle('liked');
                
                // ì¢‹ì•„ìš” ìƒíƒœ ì „ì†¡
                const clubId = button.closest('.club-card').getAttribute('href').split('/').pop();
                console.log('ì¢‹ì•„ìš” í† ê¸€:', clubId);
            }
        </script>
    </th:block>
</body>
</html>
