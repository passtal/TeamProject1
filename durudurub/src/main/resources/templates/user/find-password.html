<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- meta -->
    <th:block th:replace="~{fragments/meta :: meta}"></th:block>
    <!-- link -->
    <th:block th:replace="~{fragments/link::link}"></th:block>
    <title>비밀번호 찾기 - 두루두룹</title>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/user/find-password.css}">

    <!-- 테스트 CSS 링크 나중에 지워주세요!!!! -->
     <link rel="stylesheet" href="../../static/css/user/find-password.css">
</head>

<body layout:fragment="content" class="find-password-page">
    <!-- Main Container -->
    <div class="find-password-container">
        <div class="find-password-card">
            <!-- Close Button -->
            <button type="button" class="btn-close-find-password" onclick="window.location.href='/'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18" stroke="#99A1AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 6L18 18" stroke="#99A1AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

            <!-- Back Button -->
            <button type="button" class="btn-back" onclick="window.location.href='/login'">
                <svg class="btn-back-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 4.16667L4.16667 10L10 15.8333" stroke="#4A5565" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4.16667 10H15.8333" stroke="#4A5565" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="btn-back-text">메인화면으로 돌아가기</span>
            </button>

            <!-- Header -->
            <div class="find-password-header">
                <h1 class="find-password-title">비밀번호 찾기</h1>
                <div class="find-password-description">
                    <p>가입하신 이메일 주소를 입력해주세요.</p>
                    <p>비밀번호 재설정 안내를 보내드립니다.</p>
                </div>
            </div>

            <!-- Find Password Form -->
            <form class="find-password-form" id="findPasswordForm" onsubmit="return false;">
                <!-- Email Input -->
                <div class="form-group">
                    <label for="email" class="form-label">이메일</label>
                    <input id="email" 
                           name="email" 
                           type="email" 
                           class="form-control" 
                           placeholder="example@email.com" 
                           required>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" class="btn-submit">비밀번호 재설정 링크 받기</button>

                <!-- Info Box -->
                <div class="info-box">
                    <h3 class="info-box-title">안내사항</h3>
                    <ul class="info-box-list">
                        <li>이메일이 도착하지 않으면 스팸 메일함을 확인해주세요.</li>
                        <li>링크는 24시간 동안 유효합니다.</li>
                        <li>문제가 지속되면 관리자에게 문의해주세요.</li>
                    </ul>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" aria-live="polite" aria-atomic="true"></div>

    <script>
        // Toast notification function
        function toast(msg) {
            const el = document.getElementById("toast");
            el.textContent = msg;
            el.style.display = "block";
            clearTimeout(window._toastTimer);
            window._toastTimer = setTimeout(() => {
                el.style.display = "none";
            }, 3000);
        }

        // Email validation
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Form submit handler
        document.getElementById("findPasswordForm").addEventListener("submit", function(e) {
            e.preventDefault();
            
            const email = document.getElementById("email").value.trim();

            // Validate email
            if (!email) {
                toast("이메일을 입력해주세요.");
                return;
            }

            if (!isValidEmail(email)) {
                toast("올바른 이메일 형식이 아닙니다.");
                return;
            }

            // Send password reset request
            fetch("/api/user/find-password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json; charset=UTF-8"
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error(text || "비밀번호 재설정 링크 전송에 실패했습니다.");
                    });
                }
            })
            .then(data => {
                // 성공 시 이메일 주소와 함께 성공 페이지로 이동
                window.location.href = "/user/find-password/success?email=" + encodeURIComponent(email);
            })
            .catch(error => {
                toast(error.message);
            });
        });
    </script>
</body>
</html>
