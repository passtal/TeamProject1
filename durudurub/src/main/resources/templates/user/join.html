<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì›ê°€ì…</title>
</head>
<body layout:fragment="content">
    <div class="join-warp">
        <!-- X ë²„íŠ¼ : ë©”ì¸ìœ¼ë¡œ -->
        <a class="join-close" th:href="@{/}" aria-label="ë‹«ê¸°">x</a>

        <div class="join-header">
            <h1 class="join-logo">ë‘ë£¨ë‘ë£¹</h1>
            <p class="join-sub">ìƒˆë¡œìš´ ëª¨ì„ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
        </div>

        <div th:if="${error}" th:text="${error}"></div>

        <!-- AJAX íšŒì›ê°€ì… api/users/joinìœ¼ë¡œ ë³´ëƒ„-->
        <form class="join-form" id="joinForm" onsubmit="return false;" enctype="multipart/form-data">
        
        <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
        <div class="profile-box">
            <label for="profilImgFile">
                <div class="profile-preview" id="profilePreview">
                    <span>â¬†</span>
                </div>
                <div>í”„ë¡œí•„ ì‚¬ì§„ (ì„ íƒ)</div>
            </label>
            <!-- âš ï¸ ì§€ê¸ˆ APIëŠ” JSONë§Œ ë°›ìœ¼ë¯€ë¡œ íŒŒì¼ ì—…ë¡œë“œëŠ” ë‹¤ìŒ ë‹¨ê³„(ë©€í‹°íŒŒíŠ¸)ì—ì„œ ì²˜ë¦¬ -->
            <input type="profileImgFile" name="profileImgFile" type="file" accept="image/*" hidden>
        </div>

        <!-- ì´ë©”ì¼ -->
        <div class="field">
            <label for="userId">ì´ë©”ì¼</label>
            <input type="userId" name="userId" type="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.">
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ -->
        <div class="field">
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <div class="pw-row">
                <input type="password" name="password" type="password" placeholder="6ì ì´ìƒì…ë ¥í•˜ì„¸ìš”.">
                <button type="button" class="pw-toggle" data-target="#password" aria-label="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°">ğŸ‘</button>
            </div>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸(í”„ë¡ íŠ¸ìš©) -->
        <div class="field">
            <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <div class="pw-row">
                <input id="passwordConfirm" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                <button type="button" class="pw-toggle" data-target="#passwordConfirm" aria-label="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°">ğŸ‘</button>
            </div>
        </div>

        <!-- ë‹‰ë„¤ì„ -->
        <div class="field">
            <label for="username">ë‹‰ë„¤ì„</label>
            <input type="username" name="username" type="text" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.">
        </div>

        <!-- ì„±ë³„ -->
        <div class="field">
            <label>ì„±ë³„</label>
            <div class="gender-row">
                <label>
                    <input type="radio" name="gender" value="ë‚¨ì„±">
                    <span>ë‚¨ì„±</span>
                </label>
                <label>
                    <input type="radio" name="gender" value="ì—¬ì„±">
                    <span>ì—¬ì„±</span>
                </label>
            </div>
        </div>

        <!-- ì£¼ì†Œ -->
        <div class="field">
            <label for="address">ì£¼ì†Œ</label>
            <input id="address" name="address" type="text" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
        </div>

        <!-- ì•½ê´€ ë™ì˜ -->
        <div class="terms">
            <label>
                <input type="checkbox" id="terms1">
                <span>(í•„ìˆ˜) ì´ìš©ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤</span>
            </label>
            <label>
                <input type="checkbox" id="terms2">
                <span>(í•„ìˆ˜) ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•©ë‹ˆë‹¤</span>
            </label>
        </div>

        <button type="button" id="joinBtn">íšŒì›ê°€ì…</button>

        <div class="join-footer">
            <span>ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?</span>
            <a th:href="@{/login}">ë¡œê·¸ì¸í•˜ê¸°</a>
        </div>

        </form>
    </div>
    
    <div id="toast" aria-live="polite" aria-atomic="true"></div>
    
    <script>

        let userIdOk = false;
        let usernameOk = false;

        function toast(msg) {
            const el = document.getElementById("toast");
            el.textContent = msg;
            el.style.display = "block";
            clearTimeout(window._toastTimer);
            window._toastTimer = setTimeout(() => {
                el.style.display = "none";
            }, 2000);
        }

        function isValidEmail(email){
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function checkAge(ageStr) {
            if(!ageStr) return true;   // ë‚˜ì´ ì„ íƒ ì…ë ¥ìœ¼ë¡œ ì²˜ë¦¬
            const age = Number(ageStr);
            if(!Number.isFinite(age)) { toast("ì˜¬ë°”ë¥¸ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"); return false; }
            if(age < 15) { toast("15ì„¸ ë¯¸ë§Œì€ ì´ìš© ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤"); return flase; }
            if(age > 130) { toast("ì˜¬ë°”ë¥¸ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"); return flase; }
            return true;
        }

        // í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        $("#profileImgFile").on("change", function () {
            const file = this.files && this.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            $("#profilePreview").html('<img src="' + url + '" alt="profile" style="width:100%;height:100%;object-fit:cover;">');
        });

        // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°
        $(".pw-toggle").on("click", function(){
            const target = $(this).data("target");
            const $input = $(target);
            $input.attr("type", $input.attr("type") === "password" ? "text" : "password");
        });

        // ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬
       $("#userId").on("blur", function(){
            const userId = $(this).val().trim();

        if(!userId){
            userIdOk = false;
            toast("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”");
        return;
        }

        if(!isValidEmail(userId)){
            userIdOk = false;
            toast("ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
        return;
        }

        $.get("/api/users/check-userid", { userId })
            .done(function(res){
                userIdOk = !!res.ok;
                if(!res.ok) toast(res.message);
            })
            .fail(function(){
                userIdOk = false;
                toast("ì„œë²„ ì˜¤ë¥˜ë¡œ ì´ë©”ì¼ í™•ì¸ ì‹¤íŒ¨");
            });
        });

        // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
        $("#username").on("blur", function(){
        const username = $(this).val().trim();

        if(!username){
            usernameOk = false;
            toast("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
            return;
        }

        $.get("/api/users/check-username", { username })
            .done(function(res){
                usernameOk = !!res.ok;
                if(!res.ok) toast(res.message);
        })

        .fail(function(){
                usernameOk = false;
                toast("ì„œë²„ ì˜¤ë¥˜ë¡œ ë‹‰ë„¤ì„ í™•ì¸ ì‹¤íŒ¨");
            });
        });

        // ë‚˜ì´ ì…ë ¥ ì‹œ ì²´í¬
        $("#age").on("blur", function(){
            checkAge($(this).val().trim());
        });

        // íšŒì›ê°€ì… ë²„íŠ¼ í´ë¦­ -> AJAX íšŒì›ê°€ì…
        $("#joinBtn").on("click", function(){
            const userId = $("#userId").val().trim();
            const password = $("#password").val().trim();
            const passwordConfirm = $("#passwordConfirm").val().trim();
            const username = $("#username").val().trim();
            const ageStr = $("#age").val().trim();
            const gender = $("input[name='gender']:checked").val() || "";  // ì„ íƒ ì•ˆí•˜ë©´ ""
            const address = $("#address").val().trim();

        // í•„ìˆ˜ê°’
        if(!userId || !password || !passwordConfirm || !username){
            toast("í•„ìˆ˜ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
            return;
        }

        // ì´ë©”ì¼ í˜•ì‹
        if(!isValidEmail(userId)){
            toast("ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return;
        }

        // ë¹„ë°€ë²ˆí˜¸ ì¡°ê±´
        if(password.length < 6){
            toast("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return;
        }

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        if(password !== passwordConfirm){
            toast("ë¹„ë°€ë²ˆí˜¸ ì¬í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return;
        }

        // ë‚˜ì´ ì œí•œ
        if(!checkAge(ageStr)){
            return;
        }

        // ì•½ê´€ ë™ì˜
        if(!$("#terms1").is(":checked") || !$("#terms2").is(":checked")){
            toast("í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.")
            return;
        }

        // ì¤‘ë³µì²´í¬ í†µê³¼
        if(!userIdOk || !usernameOk){
            toast("ì´ë©”ì¼/ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.")
            return;
        }

        // APIëŠ” JSONë§Œ ë°›ìœ¼ë¯€ë¡œ í”„ë¡œì§ˆì´ë¯¸ì§€ë¥¼ ì§€ê¸ˆ ë‹¨ê³„ì—ì„œ ì „ì†¡ x
        const payload = {
            userId: userId,
            password: password,
            username: username,
            address: address,
            gender: gender,
            age: ageStr ? Number(ageStr) : 0
        };

        $.ajax({
            url: "/api/user/join",
            method: "POST",
            contentType: "application/json; charset=UTF-8",
            data: JSON.stringify(payload),
            success: function(res){
                toast("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 2ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                setTimeout(function(){
                    window.location.href = "/login";
                }, 2000);
            },
            error: function(xhr){
                const msg = xhr.responseText && xhr.responseText.trim()
                ? xhr.responseText
                : "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                toast(msg);
            }
          });
        });
    </script>    

</body>
</html>