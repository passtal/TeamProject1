<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <th:block th:replace="~{fragments/meta :: meta}"></th:block>
    <th:block th:replace="~{fragments/link::link}"></th:block>

    <title>íšŒì›ê°€ì… - ë‘ë£¨ë‘ë£¹</title>
    <link rel="stylesheet" th:href="@{/css/user/join.css}">
</head>

<body layout:fragment="content" class="join-page">
<div class="join-container">
    <div class="join-card">

        <button type="button" class="btn-close-join" th:onclick="|location.href='@{/}'|">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18" stroke="#99A1AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6 6L18 18" stroke="#99A1AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>

        <div class="join-header">
            <h1 class="join-title">ë‘ë£¨ë‘ë£¹</h1>
            <p class="join-subtitle">ìƒˆë¡œìš´ ëª¨ì„ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
        </div>

        <div th:if="${error}" th:text="${error}"
             style="color:#DC2626; margin-bottom:16px; text-align:center;"></div>

        <form class="join-form" id="joinForm" onsubmit="return false;" enctype="multipart/form-data">

            <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
            <div class="profile-section">
                <div class="profile-upload-wrapper">
                    <label for="profileImgFile" class="profile-preview" id="profilePreview">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 20L9.33333 14.6667C9.86667 14.1333 10.6667 14.1333 11.2 14.6667L16 19.4667" stroke="#99A1AF" stroke-width="2.66667" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14.6667 18.1333L16.5333 16.2667C17.0667 15.7333 17.8667 15.7333 18.4 16.2667L24 21.8667" stroke="#99A1AF" stroke-width="2.66667" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M24 12V28H8C5.79086 28 4 26.2091 4 24V8C4 5.79086 5.79086 4 8 4H24C26.2091 4 28 5.79086 28 8V12" stroke="#99A1AF" stroke-width="2.66667" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </label>

                    <label for="profileImgFile" class="profile-upload-icon">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 10L6 6C6.26667 5.73333 6.73333 5.73333 7 6L10 9" stroke="#FFFFFF" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8.66667 7.66667L9.66667 6.66667C9.93333 6.4 10.4 6.4 10.6667 6.66667L14 10" stroke="#FFFFFF" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 6V14H4C2.89543 14 2 13.1046 2 12V4C2 2.89543 2.89543 2 4 2H12C13.1046 2 14 2.89543 14 4V6" stroke="#FFFFFF" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </label>

                    <input id="profileImgFile" name="profileImgFile" type="file" accept="image/*" hidden>
                </div>
                <p class="profile-photo-label">í”„ë¡œí•„ ì‚¬ì§„ (ì„ íƒ)</p>
            </div>

            <!-- ì´ë©”ì¼ -->
            <div class="form-group">
                <label for="userId" class="form-label">ì´ë©”ì¼</label>
                <div class="input-with-button">
                    <input id="userId" name="userId" type="email" class="form-control"
                           placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    <button type="button" id="checkUserIdBtn" class="btn-dup-check">ì¤‘ë³µí™•ì¸</button>
                </div>
            </div>

            <!-- ë¹„ë°€ë²ˆí˜¸ -->
            <div class="form-group">
                <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <div class="password-input-wrapper">
                    <input id="password" name="password" type="password" class="form-control"
                           placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”" required>
                    <button type="button" class="btn-password-toggle" data-target="#password" aria-label="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°">
                        ğŸ‘
                    </button>
                </div>
            </div>

            <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
            <div class="form-group">
                <label for="passwordConfirm" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <div class="password-input-wrapper">
                    <input id="passwordConfirm" type="password" class="form-control"
                           placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required>
                    <button type="button" class="btn-password-toggle" data-target="#passwordConfirm" aria-label="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°">
                        ğŸ‘
                    </button>
                </div>
            </div>

            <!-- ë‹‰ë„¤ì„ -->
            <div class="form-group">
                <label for="username" class="form-label">ë‹‰ë„¤ì„</label>
                <div class="input-with-button">
                    <input id="username" name="username" type="text" class="form-control"
                           placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    <button type="button" id="checkUsernameBtn" class="btn-dup-check">ì¤‘ë³µí™•ì¸</button>
                </div>
            </div>

            <!-- ë‚˜ì´ -->
            <div class="form-group">
                <label for="age" class="form-label">ë‚˜ì´</label>
                <input id="age" name="age" type="number" class="form-control" placeholder="ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <!-- ì„±ë³„ -->
            <div class="form-group">
                <label class="form-label">ì„±ë³„</label>
                <div class="gender-group">
                    <div class="gender-option">
                        <input type="radio" id="genderMale" name="gender" value="ë‚¨ì„±">
                        <label for="genderMale" class="gender-label">
                            <div class="gender-radio-button"></div>
                            <span class="gender-text">ë‚¨ì„±</span>
                        </label>
                    </div>
                    <div class="gender-option">
                        <input type="radio" id="genderFemale" name="gender" value="ì—¬ì„±">
                        <label for="genderFemale" class="gender-label">
                            <div class="gender-radio-button"></div>
                            <span class="gender-text">ì—¬ì„±</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- ì£¼ì†Œ -->
            <div class="form-group">
                <label for="address" class="form-label">ì£¼ì†Œ</label>
                <input id="address" name="address" type="text" class="form-control" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <!-- ì•½ê´€ -->
            <div class="terms-section">
                <div class="terms-item">
                    <input type="checkbox" id="terms1" class="terms-checkbox">
                    <label for="terms1" class="terms-label"><span class="terms-required">(í•„ìˆ˜)</span> ì´ìš©ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤</label>
                </div>
                <div class="terms-item">
                    <input type="checkbox" id="terms2" class="terms-checkbox">
                    <label for="terms2" class="terms-label"><span class="terms-required">(í•„ìˆ˜)</span> ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•©ë‹ˆë‹¤</label>
                </div>
            </div>

            <button type="button" id="joinBtn" class="btn-submit">íšŒì›ê°€ì…</button>

            <div class="login-prompt">
                <span class="login-prompt-text">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?</span>
                <a th:href="@{/login}" class="btn-login">ë¡œê·¸ì¸í•˜ê¸°</a>
            </div>
        </form>
    </div>
</div>

<div id="toast" aria-live="polite" aria-atomic="true"></div>

<script>
    let userIdOk = false;
    let usernameOk = false;

    function toast(msg) {
        const el = document.getElementById("toast");
        el.textContent = msg;
        el.style.display = "block";
        clearTimeout(window._toastTimer);
        window._toastTimer = setTimeout(() => el.style.display = "none", 2000);
    }

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    document.getElementById("profileImgFile").addEventListener("change", function () {
        const file = this.files && this.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        document.getElementById("profilePreview").innerHTML =
            '<img src="' + url + '" alt="profile" style="width:100%;height:100%;object-fit:cover;">';
    });

    // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸° í† ê¸€ (ë„ˆ ì½”ë“œ í´ë˜ìŠ¤ëª…ì— ë§ì¶¤)
    document.querySelectorAll(".btn-password-toggle").forEach(btn => {
        btn.addEventListener("click", function() {
            const target = this.getAttribute("data-target");
            const input = document.querySelector(target);
            if (!input) return;
            input.type = (input.type === "password") ? "text" : "password";
        });
    });

    // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
    document.getElementById("checkUserIdBtn").addEventListener("click", function(){
        const userId = document.getElementById("userId").value.trim();

        if(!userId) return toast("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”");
        if(!isValidEmail(userId)) return toast("ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");

        fetch("/api/user/check-id?userId=" + encodeURIComponent(userId))
            .then(res => res.json())
            .then(exists => {
                // ë°±ì—”ë“œëŠ” exists(boolean)ë§Œ ë‚´ë ¤ì¤Œ (ë„¤ UserController ê¸°ì¤€)
                userIdOk = !exists;
                toast(userIdOk ? "ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤." : "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
            })
            .catch(() => {
                userIdOk = false;
                toast("ì„œë²„ ì˜¤ë¥˜ë¡œ ì´ë©”ì¼ í™•ì¸ ì‹¤íŒ¨");
            });
    });

    // ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸
    document.getElementById("checkUsernameBtn").addEventListener("click", function(){
        const username = document.getElementById("username").value.trim();

        if(!username) return toast("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");

        fetch("/api/user/check-username?username=" + encodeURIComponent(username))
            .then(res => res.json())
            .then(exists => {
                usernameOk = !exists;
                toast(usernameOk ? "ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤." : "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.");
            })
            .catch(() => {
                usernameOk = false;
                toast("ì„œë²„ ì˜¤ë¥˜ë¡œ ë‹‰ë„¤ì„ í™•ì¸ ì‹¤íŒ¨");
            });
    });

    // íšŒì›ê°€ì…
    document.getElementById("joinBtn").addEventListener("click", function(){
        const userId = document.getElementById("userId").value.trim();
        const password = document.getElementById("password").value.trim();
        const passwordConfirm = document.getElementById("passwordConfirm").value.trim();
        const username = document.getElementById("username").value.trim();
        const ageStr = document.getElementById("age").value.trim();
        const genderInput = document.querySelector("input[name='gender']:checked");
        const gender = genderInput ? genderInput.value : "";
        const address = document.getElementById("address").value.trim();

        if(!userId || !password || !passwordConfirm || !username) return toast("í•„ìˆ˜ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        if(!isValidEmail(userId)) return toast("ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        if(password.length < 6) return toast("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if(password !== passwordConfirm) return toast("ë¹„ë°€ë²ˆí˜¸ ì¬í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

        const terms1 = document.getElementById("terms1").checked;
        const terms2 = document.getElementById("terms2").checked;
        if(!terms1 || !terms2) return toast("í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.");

        if(!userIdOk || !usernameOk) return toast("ì´ë©”ì¼/ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");

        const formData = new FormData();
        formData.append("userId", userId);
        formData.append("password", password);
        formData.append("username", username);
        formData.append("address", address);
        formData.append("gender", gender);
        formData.append("age", ageStr ? Number(ageStr) : 0);

        const profileInput = document.getElementById("profileImgFile");
        if (profileInput.files && profileInput.files[0]) {
            formData.append("profileImgFile", profileInput.files[0]);
        }

        fetch("/api/user/join", { method: "POST", body: formData })
            .then(res => res.ok ? res.text() : res.text().then(t => { throw new Error(t); }))
            .then(() => {
                toast("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 2ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                setTimeout(() => window.location.href = "/login", 2000);
            })
            .catch(err => toast(err.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
    });
</script>
</body>
</html>
