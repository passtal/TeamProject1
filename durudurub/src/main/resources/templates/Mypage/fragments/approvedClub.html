<!-- 가입된 fragment -->
<div th:fragment="content">
    <!-- 가입 중인 모임 -->
    <!-- <div class="approved-container"> -->
        <div class="tab-content active">
            <div th:if="${#lists.isEmpty(approvedClub)}">
                <p style="text-align:center">가입한 모임이 없습니다.</p>
            </div>
            <div th:unless="${#lists.isEmpty(approvedClub)}" class="cardList">
                <div th:each="club : ${approvedClub}" class="club-card" th:attr="data-club-no=${club.no}" style="cursor: pointer;">
                    <div class="club-info">
                        <div class="club-icon">
                            <span class="material-symbols-outlined">group</span>
                        </div>
                        <div class="club-details">
                            <div class="club-title-row">
                                <h3 class="club-title" th:text="${club.title}">모임명</h3>
                            </div>
                            <p class="club-category" th:text="${club.category != null ? club.category.name : '카테고리 없음'}">카테고리명</p>
                            <p class="club-members" th:text="|멤버 ${club.currentMembers}/${club.maxMembers}명|">가입 멤버수</p>
                        </div>
                    </div>
                    <div class="club-actions">
                        <button class="btn-leave" th:attr="data-clubno=${club.no}" onclick="clubOpenModal(this);">
                            <span class="material-symbols-outlined">logout</span>
                            <span>탈퇴</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <!-- 모임 탈퇴 모달 -->
    <div id="leaveClubModal" class="leave-modal">
        <div class="leave-modal-content">
            <div class="leave-modal-header">
                <h3 class="leave-modal-title">모임 탈퇴</h3>
                <button id="modalCloseBtn" class="leave-modal-close" onclick="clubCloseModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="leave-modal-warning">
                <p class="leave-modal-warning-title">모임에서 탈퇴 하시겠습니까?</p>
                <p class="leave-modal-warning-text">탈퇴하면 더 이상 모임 활동을 할 수 없습니다.</p>
            </div>
            <div class="leave-modal-actions">
                <button id="modalCancelBtn" class="leave-modal-btn leave-modal-btn-cancel" onclick="clubCloseModal()">취소</button>
                <button id="modalConfirmBtn" class="leave-modal-btn leave-modal-btn-confirm">탈퇴하기</button>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script>
        // 탈퇴하기 버튼
        $(document).on("click", "#modalConfirmBtn", function () {
            // this 필요!
            const btn = $(this);
            const clubNo = btn.data("clubno");

            // CSRF 토큰 문제 (403)
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: `/users/mypage/club/api/${clubNo}`,
                method: 'DELETE',
                beforeSend: function (xhr) {     
                    xhr.setRequestHeader(header, token);
                },
                success: function (result, status, xhr) {
                    alert("탈퇴가 완료되었습니다")
                    // 가입된 모임리스트 수 감소
                    countList("APPROVED", -1)
                    // 탈퇴한 모임리스트 카드 삭제
                    $(`.club-card[data-club-no="${clubNo}"]`).remove();
                    // 모달 닫기
                    clubCloseModal()
                    location.reload()
                }, 
                error: function (xhr, status, error) {
                    // xhr : AJAX 요청에 대한 전체 HTTP 응답 객체
                    // status : AJAX 요청 상태를 문자열로 나타낸 것
                    if (xhr.status === 404) {
                        alert("잘못된 요청입니다");
                    } else {
                        alert("서버 내부 오류입니다.")
                    }
                }
            })
        })
        // 모임 탈퇴 - 모달 열기 (탈퇴하기 버튼)
        function clubOpenModal(btnEl) {
            const clubNo = $(btnEl).data("clubno")
            $("#modalConfirmBtn").data("clubno", clubNo)
            $("#leaveClubModal").show()
        }
        // 모임 탈퇴 - 모달 닫기 
        function clubCloseModal() {
            $("#leaveClubModal").hide()
        }
        </script>
    </th:block>
</div>

