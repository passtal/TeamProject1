<!-- 대시보드 fragment -->
<div th:fragment="content">
    <!-- 카테고리 관리 섹션 -->
    <div class="categories-section">
        <div class="section-header">
            <h2>카테고리 관리</h2>
            <button class="btn-add-category" onclick="addParentCategory()">
                <span class="material-symbols-outlined">add</span>
                대분류 추가
            </button>
        </div>

        <div class="categories-container" id="categories-container">
            <div class="category-empty">
                등록된 카테고리가 없습니다.
            </div>
        </div>

    </div>

    <!-- 대분류 추가 모달 -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2>카테고리 추가</h2>
                </div>
                <button class="modal-close" onclick="closeAddModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="modal-form">
                    <!-- 카테고리 이미지 -->
                    <div class="form-row image-row">
                        <div class="category-image-upload">
                            <label for="categoryImageInput" class="image-upload-label">
                                <div class="image-preview" id="imagePreview">
                                    <span class="material-symbols-outlined">image</span>
                                </div>
                            </label>
                            <input type="file" id="categoryImageInput" accept="image/*" style="display: none;">
                        </div>
                    </div>

                    <!-- 분류 타입 -->
                    <div class="form-row">
                        <label class="form-label">분류 타입</label>
                        <div class="form-input-readonly">대분류</div>
                    </div>

                    <!-- 카테고리명 -->
                    <div class="form-row">
                        <label class="form-label">카테고리명 *</label>
                        <input type="text" id="categoryName" class="form-input" placeholder="예: 독서, 운동, 요리" maxlength="5">
                        <div class="form-hint">
                            <span id="nameCounter">0/5자</span>
                        </div>
                    </div>

                    <!-- 설명 -->
                    <div class="form-row">
                        <label class="form-label">설명</label>
                        <textarea id="categoryDesc" class="form-textarea" placeholder="카테고리에 대한 간단한 설명을 입력하세요" rows="4"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAddModal()">취소</button>
                <button class="btn-submit" onclick="submitCategory()">추가</button>
            </div>
        </div>
    </div>

    <!-- 소분류 추가 모달 -->
    <div id="addSubCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2>카테고리 추가</h2>
                </div>
                <button class="modal-close" onclick="closeAddSubModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="modal-form">
                    <!-- 분류 타입 -->
                    <div class="form-row">
                        <label class="form-label">분류 타입</label>
                        <div class="form-input-readonly" id="subCategoryType">소분류 (상위: 독서)</div>
                    </div>

                    <!-- 카테고리명 -->
                    <div class="form-row">
                        <label class="form-label">카테고리명 *</label>
                        <input type="text" id="subCategoryName" class="form-input" placeholder="예: 독서, 운동, 요리" maxlength="5">
                        <div class="form-hint">
                            <span id="subNameCounter">0/5자</span>
                        </div>
                    </div>

                    <!-- 설명 -->
                    <div class="form-row">
                        <label class="form-label">설명</label>
                        <textarea id="subCategoryDesc" class="form-textarea" placeholder="카테고리에 대한 간단한 설명을 입력하세요" rows="4"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAddSubModal()">취소</button>
                <button class="btn-submit" onclick="submitSubCategory()">추가</button>
            </div>
        </div>
    </div>

    <!-- 카테고리 삭제 확인 모달 -->
    <div id="deleteCategoryModal" class="modal">
        <div class="modal-content delete-modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2>카테고리 삭제 확인</h2>
                </div>
                <button class="modal-close" onclick="closeDeleteModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="delete-message">
                    <p class="delete-question">정말로 이 카테고리를 삭제하시겠습니까?</p>
                    <p class="delete-warning" id="deleteWarningText">현재 1개의 모임이 이 카테고리를 사용 중입니다.</p>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeDeleteModal()">취소</button>
                <button class="btn-delete-confirm" onclick="confirmDeleteCategory()">삭제</button>
            </div>
        </div>
    </div>

    <!-- 카테고리 수정 모달 -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2>카테고리 수정</h2>
                </div>
                <button class="modal-close" onclick="closeEditModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="modal-form">
                    <!-- 카테고리 이미지 -->
                    <div class="form-row image-row">
                        <div class="category-image-upload">
                            <label for="editCategoryImageInput" class="image-upload-label">
                                <div class="image-preview" id="editImagePreview">
                                    <span class="material-symbols-outlined">image</span>
                                </div>
                            </label>
                            <input type="file" id="editCategoryImageInput" accept="image/*" style="display: none;">
                        </div>
                    </div>

                    <!-- 분류 타입 -->
                    <div class="form-row">
                        <label class="form-label">분류 타입</label>
                        <div class="form-input-readonly">대분류</div>
                    </div>

                    <!-- 카테고리명 -->
                    <div class="form-row">
                        <label class="form-label">카테고리명 *</label>
                        <input type="text" id="editCategoryName" class="form-input" placeholder="예: 독서, 운동, 요리" maxlength="5">
                        <div class="form-hint">
                            <span id="editNameCounter">0/5자</span>
                        </div>
                    </div>

                    <!-- 설명 -->
                    <div class="form-row">
                        <label class="form-label">설명</label>
                        <textarea id="editCategoryDesc" class="form-textarea" placeholder="카테고리에 대한 간단한 설명을 입력하세요" rows="4"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeEditModal()">취소</button>
                <button class="btn-submit" onclick="submitEditCategory()">수정</button>
            </div>
        </div>
    </div>

    <!-- 소분류 삭제 확인 모달 -->
    <div id="deleteSubCategoryModal" class="modal">
        <div class="modal-content delete-modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2>소분류 삭제 확인</h2>
                </div>
                <button class="modal-close" onclick="closeSubDeleteModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="delete-message">
                    <p class="delete-question">정말로 이 소분류를 삭제하시겠습니까?</p>
                    <p class="delete-warning" id="subDeleteWarningText">소분류: <span id="subDeleteName"></span></p>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeSubDeleteModal()">취소</button>
                <button class="btn-delete-confirm" onclick="confirmDeleteSubCategory()">삭제</button>
            </div>
        </div>
    </div>
</div>


<th:block layout:fragment="script">
    <script>
        let currentEditId = null;
        let currentDeleteId = null;

        let currentParentId = null; // 소분류 추가 시 상위 카테고리 ID
        let currentParentName = null; // 소분류 추가 시 상위 카테고리명

        let currentSubDeleteId = null; // 삭제할 소분류 ID
        let selectedSubTag = null; // 현재 선택된 소분류 태그
        let subTagTimer = null; // 소분류 태그 타이머

        // 카테고리 갱신 
        window.__categoriesCache = window.__categoriesCache ?? [];

        function getCsrf() {
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");
            return { token, header };
        }

        // onclick 문자열 깨짐 방지
        function escapeJs(str) {
            if (str == null) return '';
            return String(str).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        }

        // XSS 방지용(HTML 문자열로 렌더링하므로 필수)
        function escapeHtml(str) {
            if (str == null) return '';
            return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
        }

        // 토스트 메시지 표시 함수
        /* 사용 방법 : 
        showToast('수정 완료', 'success');  // 성공
        showToast('수정 실패', 'error');    // 실패
        */
        function showToast(message, type = 'success') {
            alert(message);
            // 3초 후 자동 숨김
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        // ------------------모달
        // 추가 모달 - 카테고리명 글자수 카운터
        document.getElementById('categoryName').addEventListener('input', function(e) {
            const counter = document.getElementById('nameCounter');
            counter.textContent = `${e.target.value.length}/5자`;
        });

        // 소분류 추가 모달 - 카테고리명 글자수 카운터
        document.getElementById('subCategoryName').addEventListener('input', function(e) {
            const counter = document.getElementById('subNameCounter');
            counter.textContent = `${e.target.value.length}/5자`;
        });

        // 추가 모달 - 이미지 업로드 미리보기
        document.getElementById('categoryImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // 수정 모달 - 카테고리명 글자수 카운터
        document.getElementById('editCategoryName').addEventListener('input', function(e) {
            const counter = document.getElementById('editNameCounter');
            counter.textContent = `${e.target.value.length}/5자`;
        });

        // 수정 모달 - 이미지 업로드 미리보기
        document.getElementById('editCategoryImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('editImagePreview');
                    preview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });
        // 모달 열고 닫기
        function addParentCategory() {
            document.getElementById('addCategoryModal').classList.add('active');
        }

        function closeAddModal() {
            const modal = document.getElementById('addCategoryModal');
            modal.classList.remove('active');
            // 폼 초기화
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryDesc').value = '';
            document.getElementById('nameCounter').textContent = '0/5자';
            document.getElementById('imagePreview').innerHTML = '<span class="material-symbols-outlined">image</span>';
            const fileInput = document.getElementById('categoryImageInput');
            if (fileInput) fileInput.value = '';
        }

        function closeEditModal() {
            document.getElementById('editCategoryModal').classList.remove('active');
            currentEditId = null;
            const fileInput = document.getElementById('editCategoryImageInput');
            if (fileInput) fileInput.value = '';
        }

        function closeDeleteModal() {
            document.getElementById('deleteCategoryModal').classList.remove('active');
            currentDeleteId = null;
        }

        function closeAddSubModal() {
            const modal = document.getElementById('addSubCategoryModal');
            modal.classList.remove('active');
            document.getElementById('subCategoryName').value = '';
            document.getElementById('subCategoryDesc').value = '';
            document.getElementById('subNameCounter').textContent = '0/5자';
            currentParentId = null;
            currentParentName = null;
        }

        function closeSubDeleteModal() {
            document.getElementById('deleteSubCategoryModal').classList.remove('active');
            currentSubDeleteId = null;
        }

        // ------------------ajax
        // 리스트 조회
        function getList() {
            $.ajax({
            url: `/admin/api/categories`,
            method: 'GET',
            dataType: 'json',
            success: function(list) {
                window.__categoriesCache = Array.isArray(list) ? list : [];
                renderCategories(window.__categoriesCache);
            },
            error: function(xhr, status, error) {
                console.error('*****status:', status);
                console.error('*****http status code:', xhr.status);
                console.error('*****error:', error);
                console.error('*****responseText:', xhr.responseText);
                showToast('카테고리 조회 실패', 'error');
            }
            });
        }

        // 렌더링 - container 내부  -> 서버데이터
        function renderCategories(categories) {
            const container = document.querySelector('.categories-container');
            if (!container) return;

            if (!categories || categories.length === 0) {
            container.innerHTML = `
                <div style="padding:18px; color:#6b7280; font-weight:700;">
                등록된 카테고리가 없습니다.
                </div>
            `;
            return;
            }
            
            let html = '';
            for (const c of categories) {
            const no = c.no;
            const name = escapeHtml(c.name || '');
            const desc = escapeHtml(c.description || '');
            const subList = c.subCategories || c.subCategoryList || []; 
            const iconText = (c.name || '').length >= 2 ? (c.name || '').slice(0, 2) : (c.name || '');
            const badgeHtml = c.icon
            ? `<img src="${escapeHtml(c.icon)}?v=${Date.now()}" alt="${name}">`
            : `<span class="badge-text">${escapeHtml(iconText)}</span>`;


            // 소분류 버튼 + 태그들 (HTML 구조 유지)
            let subHtml = `
                <button class="sub-tag sub-tag-add" onclick="addSubCategory(${no})">
                <span class="material-symbols-outlined">add</span>
                소분류 추가
                </button>
            `;

            for (const s of subList) {
                const subNo = s.no;
                const subName = escapeHtml(s.name || '');
                subHtml += `
                <div class="sub-tag" data-sub-id="${subNo}" onclick="selectSubCategory(this)">
                    <span class="sub-tag-text">${subName}</span>
                    <button class="sub-tag-delete"
                    onclick="event.stopPropagation(); showSubDeleteModal(${subNo}, '${escapeJs(s.name || '')}')">
                    <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
                `;
            }

            const clubCount = (c.clubCount != null) ? c.clubCount : 0;

            html += `
                <div class="category-card" data-category-id="${no}">
                <div class="card-decoration"></div>
                <div class="card-header">
                    <div class="header-left">
                    <div class="category-badge">
                        ${badgeHtml}
                    </div>
                    <div class="category-info">
                        <h3>${name}</h3>
                        <p>${desc}</p>
                    </div>
                    </div>
                    <div class="header-right">
                    <div class="club-count">${clubCount}개 모임</div>
                    <button class="btn-icon" onclick="editCategory(${no})" title="편집">
                        <span class="material-symbols-outlined">edit</span>
                    </button>
                    <button class="btn-icon btn-delete" onclick="deleteCategory(${no})" title="삭제" style="padding: 0px;">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                    </div>
                </div>
                <div class="card-body">
                    ${subHtml}
                </div>
                </div>
            `;
            }

            container.innerHTML = html;
        }
        //---------------대분류
        // 대분류 추가
        function submitCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDesc').value.trim();
            const file = document.getElementById('categoryImageInput').files[0];

            if (!name) { showToast('카테고리명을 입력하세요.', 'error'); return; }

            const formData = new FormData();
            formData.append("name", name);
            formData.append("description", description);
            formData.append("seq", 1);
            if (file) formData.append("iconFile", file);

            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: "/admin/api/categories/create",
                method: "POST",
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: (xhr) => xhr.setRequestHeader(header, token),
                success: () => { showToast('카테고리가 추가되었습니다.', 'success'); closeAddModal(); getList(); },
                error: () => showToast('카테고리 추가에 실패했습니다.', 'error')
            });
        }

        // 대분류 수정
        function editCategory(id) {
            currentEditId = id;

            const category = (window.__categoriesCache || []).find(c => c.no === id);
            if (!category) {
            showToast('카테고리 정보를 찾을 수 없습니다.', 'error');
            return;
            }

            document.getElementById('editCategoryName').value = category.name || '';
            document.getElementById('editCategoryDesc').value = category.description || '';
            document.getElementById('editNameCounter').textContent =
            `${(category.name || '').length}/5자`;

            // 이미지 미리보기
            const preview = document.getElementById('editImagePreview');
            if (category.icon) {
                preview.innerHTML = `<img src="${category.icon}" alt="icon">`;
            } else {
                preview.innerHTML = '<span class="material-symbols-outlined">image</span>';
            }

            document.getElementById('editCategoryModal').classList.add('active');
        }

        function submitEditCategory() {
            const name = document.getElementById('editCategoryName').value.trim();
            const description = document.getElementById('editCategoryDesc').value.trim();
            const file = document.getElementById('editCategoryImageInput').files[0];

            if (!name) {
                showToast('카테고리명을 입력하세요.', 'error');
                return;
            }
            if (!currentEditId) {
                showToast('수정 대상이 없습니다.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append("name", name);
            formData.append("description", description);
            // seq 정책이 있다면 넣기. 없으면 아예 빼도 됨.
            formData.append("seq", 1);
            if (file) formData.append("iconFile", file);

            const { token, header } = getCsrf();

            $.ajax({
                url: `/admin/api/categories/${currentEditId}/update`,
                method: 'PUT',
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function (xhr) {
                if (header && token) xhr.setRequestHeader(header, token);
                },
                success: function() {
                showToast('수정 완료', 'success');
                closeEditModal();
                getList();
                },
                error: function(xhr) {
                console.error(xhr.responseText);
                showToast('수정 실패', 'error');
                }
            });
        }
        // 대분류 삭제
        function deleteCategory(id) {
            currentDeleteId = id;

            const category = (window.__categoriesCache || []).find(c => c.no === id);
            const count = category && category.clubCount != null ? category.clubCount : 0;

            const warningText = document.getElementById('deleteWarningText');
            warningText.textContent = `현재 ${count}개의 모임이 이 카테고리를 사용 중입니다.`;

            document.getElementById('deleteCategoryModal').classList.add('active');
        }

        function confirmDeleteCategory() {
            if (!currentDeleteId) return;

            const { token, header } = getCsrf();

            $.ajax({
            url: `/admin/api/categories/${currentDeleteId}`,
            method: 'DELETE',
            beforeSend: function (xhr) {
                if (header && token) xhr.setRequestHeader(header, token);
            },
            success: function(res) {
                showToast('삭제 완료', 'success');
                closeDeleteModal();
                getList();
            },
            error: function(xhr) {
                console.error(xhr.responseText);
                showToast('삭제 실패', 'error');
            }
            });
        }

        // ------------------소분류
        // 소분류 추가
        function addSubCategory(parentId) {
            const category = (window.__categoriesCache || []).find(c => c.no === parentId);

            currentParentId = parentId;
            currentParentName = category ? category.name : '알 수 없음';

            document.getElementById('subCategoryType').textContent =
            `소분류 (상위: ${currentParentName})`;

            document.getElementById('addSubCategoryModal').classList.add('active');
        }

        function submitSubCategory() {
            const name = document.getElementById('subCategoryName').value.trim();
            const desc = document.getElementById('subCategoryDesc').value.trim(); 

            if (!name) {
            showToast('카테고리명을 입력하세요.', 'error');
            return;
            }
            if (!currentParentId) {
            showToast('상위 카테고리를 찾을 수 없습니다.', 'error');
            return;
            }

            const payload = {
            name: name,
            seq: 0
            };

            const { token, header } = getCsrf();

            $.ajax({
            url: `/admin/api/categories/${currentParentId}/subs`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            beforeSend: function (xhr) {
                if (header && token) xhr.setRequestHeader(header, token);
            },
            success: function(res) {
                showToast('소분류가 추가되었습니다.', 'success');
                closeAddSubModal();
                getList();
            },
            error: function(xhr) {
                console.error(xhr.responseText);
                showToast('소분류 추가에 실패했습니다.', 'error');
            }
            });
        }
        // 소분류 선택
        function selectSubCategory(element) {
            if (selectedSubTag && selectedSubTag !== element) {
            selectedSubTag.classList.remove('selected');
            clearTimeout(subTagTimer);
            }

            selectedSubTag = element;
            element.classList.add('selected');

            subTagTimer = setTimeout(() => {
            if (selectedSubTag) {
                selectedSubTag.classList.remove('selected');
                selectedSubTag = null;
            }
            }, 2000);
        }
        // 소분류 삭제
        function showSubDeleteModal(subId, subName) {
            currentSubDeleteId = subId;
            document.getElementById('subDeleteName').textContent = subName;
            document.getElementById('deleteSubCategoryModal').classList.add('active');

            if (selectedSubTag) {
            selectedSubTag.classList.remove('selected');
            selectedSubTag = null;
            }
            clearTimeout(subTagTimer);
        }

        function confirmDeleteSubCategory() {
            if (!currentSubDeleteId) return;

            const { token, header } = getCsrf();

            $.ajax({
            url: `/admin/api/categories/subs/${currentSubDeleteId}`,
            method: 'DELETE',
            beforeSend: function (xhr) {
                if (header && token) xhr.setRequestHeader(header, token);
            },
            success: function(res) {
                showToast('소분류 삭제 완료', 'success');
                closeSubDeleteModal();
                getList();
            },
            error: function(xhr) {
                console.error(xhr.responseText);
                showToast('소분류 삭제 실패', 'error');
            }
            });
        }

        // 로딩
        getList();
    </script>
</th:block>

