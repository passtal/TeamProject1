<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{/layouts/main_layout}"
      th:with="isAdminPage=true">
<head>
    <title>사용자 관리 - 두루두룹</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/admin/dashboard.css}">
        <link rel="stylesheet" th:href="@{/css/admin/users.css}">
    </th:block>
</head>
<body>
    <main layout:fragment="content" class="main-content">
        <!-- 헤더 -->
        <header class="page-header">
            <div class="header-left">
                <h1>관리자 대시보드</h1>
                <p>두루두룹 서비스 관리</p>
            </div>
            <button class="btn-main" onclick="location.href='/'">
                메인으로
            </button>
        </header>

        <!-- 네비 -->
        <nav class="admin-nav">
            <button class="nav-tab" onclick="location.href='/admin/dashboard'">
                <span class="material-symbols-outlined">dashboard</span>
                <span>대시보드</span>
            </button>
            <button class="nav-tab active">
                <span class="material-symbols-outlined">group</span>
                <span>사용자 관리</span>
            </button>
            <button class="nav-tab" onclick="location.href='/admin/clubs'">
                <span class="material-symbols-outlined">groups</span>
                <span>모임 관리</span>
            </button>
            <button class="nav-tab" onclick="location.href='/admin/reports'">
                <span class="material-symbols-outlined">report</span>
                <span>신고 관리</span>
            </button>
            <button class="nav-tab" onclick="location.href='/admin/banners'">
                <span class="material-symbols-outlined">image</span>
                <span>광고 배너 관리</span>
            </button>
            <button class="nav-tab" onclick="location.href='/admin/categories'">
                <span class="material-symbols-outlined">category</span>
                <span>카테고리 관리</span>
            </button>
        </nav>

        <!-- 사용자 목록 Section -->
        <section class="users-section">
            <!-- 검색창 -->
            <div class="search-bar">
                <span class="material-symbols-outlined">search</span>
                <input type="text" placeholder="닉네임 또는 이메일 검색..." id="userSearch">
            </div>

            <!-- 사용자 Table -->
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr id="users-title">
                            <th>닉네임</th>
                            <th>이메일</th>
                            <th>가입일</th>
                            <th>구독 상태</th>
                            <th>삭제</th>
                        </tr>
                    </thead>
                    <tbody id="users-body">
                        <tr id="users-data" onclick="showUserDetail()">
                            <td colspan="10">조회된 데이터가 없습니다.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 사용자 상세정보 모달 -->
        <div class="modal-overlay" id="userDetailModal" th:object="${user}">
        <div class="modal-container">
            <div class="modal-header">
                <h2>사용자 상세 정보</h2>
                <button class="btn-close-modal" onclick="closeUserDetail()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="detail-row">
                    <div class="detail-label">닉네임</div>
                    <div class="detail-value" id="detailUsername">
                        <span th:text="*{username}"></span>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">이메일</div>
                    <div class="detail-value" id="detailUserId">
                        <span th:text="*{userId}"></span>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">가입일</div>
                    <div class="detail-value" id="detailCreatedAt">
                        <span th:text="*{createdAt}"></span>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">구독 상태</div>
                    <div id="detailBadge">
                        <span th:text="*{gender}"></span>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">신고 횟수</div>
                    <div class="report-badge" id="detailReportCount">0회</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">사용자 ID</div>
                    <div class="detail-value user-id" id="detailUserId">#1</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-close" onclick="closeUserDetail()">닫기</button>
            </div>
        </div>
    </div>

    <!--사용자 삭제 모달 -->
    <!-- <div class="modal-overlay" id="deleteConfirmModal">
        <div class="modal-container-small">
            <div class="modal-header">
                <h2>사용자 삭제 확인</h2>
                <button class="btn-close-modal" onclick="closeDeleteConfirm()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body-small">
                <p id="deleteMessage">정말로 사용자 ID #1을 삭제하시겠습니까?</p>
            </div>
            <div class="modal-footer-confirm">
                <button class="btn-cancel" onclick="closeDeleteConfirm()">취소</button>
                <button class="btn-confirm-delete" onclick="confirmDelete()">삭제</button>
            </div>
        </div>
    </div> -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        // 검색 기능
        // document.getElementById('userSearch').addEventListener('input', function(e) {
        //     const searchTerm = e.target.value.toLowerCase();
        //     const rows = document.querySelectorAll('.users-table tbody tr');
            
        //     rows.forEach(row => {
        //         const nickname = row.cells[0].textContent.toLowerCase();
        //         const email = row.cells[1].textContent.toLowerCase();
                
        //         if (nickname.includes(searchTerm) || email.includes(searchTerm)) {
        //             row.style.display = '';
        //         } else {
        //             row.style.display = 'none';
        //         }
        //     });
        // });

        // 사용자 목록 조회
        function getList() {
            let url = `/admin/users/list`

            $.ajax({
                url: url,
                method: 'GET',
                dataType: 'json',
                success: function(userList) {

                    if (userList.length == 0) {
                        alert('조회된 사용자가 없습니다.')
                    } else {
                        $('#users-body').empty()
                        
                        let tr = ''
                        // user.gender -> 컬럼 추가 시 구독중, 미구독 변수명으로 바꾸기!
                        for (const user of userList) {
                            tr += `<tr>
                                    <td>${user.username}</td>
                                    <td>${user.userId}</td>
                                    <td>${formatDate(user.createdAt)}</td>
                                    <td><span class="badge badge-admin">${user.gender}</span></td>
                                    <td>
                                        <button class="btn-delete" onclick="deleteUser(this, event)">
                                        <span class="material-symbols-outlined">delete</span>
                                        </button>
                                    </td>
                                </tr>`
                        }
                        $('#users-body').html(tr)
                    }
                },
                error: function (xhr, status, error) {
                    console.error('★★★★ Error : ', error) 
                    alert("사용자 조회 실패!!")
                }
            })
        }
        getList()
        
        // 날짜 형식
        function formatDate(dateStr) {
            const date = new Date(dateStr)

            const yyyy = date.getFullYear()
            // getMonth : 1월(0) ~12월(1) -> 실제 날짜 0+1 '1월'
            // padStart : 문자열 자리수(2), 앞자리('0')
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            // getDate : 이미 1부터 시작
            const dd = String(date.getDate()).padStart(2, '0');

            return `${yyyy}.${mm}.${dd}`;
        }

        // 사용자 상세 정보 표시
        function showUserDetail(nickname, email, joinDate, status, reportCount, userId) {
            document.getElementById('detailNickname').textContent = nickname;
            document.getElementById('detailEmail').textContent = email;
            
            // 가입일 포맷 변경 (2024. 1. 15. → 2024년 1월 15일)
            const dateFormatted = joinDate.replace(/\./g, '').trim();
            const [year, month, day] = dateFormatted.split(' ');
            document.getElementById('detailJoinDate').textContent = `${year}년 ${month}월 ${day}일 오후 06:00`;
            
            // 구독 상태 배지
            const badgeContainer = document.getElementById('detailBadge');
            let badgeClass = '';
            let badgeText = '';
            
            if (gender === 'admin') {
                badgeClass = 'badge badge-admin';
                badgeText = '관리자';
            } else if (gender === 'subscribed') {
                badgeClass = 'badge badge-subscribed';
                badgeText = '구독 중';
            } else {
                badgeClass = 'badge badge-unsubscribed';
                badgeText = '미구독';
            }
            
            badgeContainer.innerHTML = `<span class="${badgeClass}">${badgeText}</span>`;
            
            // 신고 횟수
            document.getElementById('detailReportCount').textContent = `${reportCount}회`;
            
            // 사용자 ID
            document.getElementById('detailUserId').textContent = `#${userId}`;
            
            // 모달 표시
            document.getElementById('userDetailModal').style.display = 'flex';
        }
        
        // 모달 닫기
        function closeUserDetail() {
            document.getElementById('userDetailModal').style.display = 'none';
        }
        
        // // 모달 외부 클릭 시 닫기
        // document.getElementById('userDetailModal').addEventListener('click', function(e) {
        //     if (e.target === this) {
        //         closeUserDetail();
        //     }
        // });

        // // 사용자 삭제 기능
        // let rowToDelete = null;
        
        // function deleteUser(btn, event) {
        //     event.stopPropagation(); // 행 클릭 이벤트 방지
        //     rowToDelete = btn.closest('tr');
        //     const nickname = rowToDelete.cells[0].textContent;
        //     const userId = rowToDelete.getAttribute('data-user-id') || '1';
            
        //     // 모달에 메시지 설정
        //     document.getElementById('deleteMessage').textContent = `정말로 사용자 ID #${userId}을 삭제하시겠습니까?`;
            
        //     // 모달 표시
        //     document.getElementById('deleteConfirmModal').style.display = 'flex';
        // }
        
        // function confirmDelete() {
        //     if (rowToDelete) {
        //         // TODO: Ajax로 서버에 삭제 요청
        //         rowToDelete.remove();
        //         rowToDelete = null;
        //         closeDeleteConfirm();
        //     }
        // }
        
        // function closeDeleteConfirm() {
        //     document.getElementById('deleteConfirmModal').style.display = 'none';
        //     rowToDelete = null;
        // }
        
        // // 모달 외부 클릭 시 닫기
        // document.getElementById('deleteConfirmModal').addEventListener('click', function(e) {
        //     if (e.target === this) {
        //         closeDeleteConfirm();
        //     }
        // });
        </script>
    </main>
</body>
</html>
