<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{/layouts/main_layout}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>공지사항 작성 - 두루두룹</title>
    <link rel="stylesheet" th:href="@{/css/notice/notice-insert.css}">
</head>
<body layout:fragment="content">

<!-- 상단 헤더 -->
<div class="notice-header">
    <div class="header-container">
        <a href="javascript:history.back();" class="btn-back">
            <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <h1 class="page-title">공지사항 작성</h1>
    </div>
</div>

<div class="notice-insert-page">

    <!-- 폼 컨테이너 -->
    <form id="noticeForm" class="notice-form">
        <div class="form-content">
            <!-- 제목 -->
            <div class="form-group">
                <label class="form-label">제목 *</label>
                <input type="text" name="title" class="form-input" placeholder="공지사항 제목을 입력하세요" required>
            </div>

            <!-- 카테고리 -->
            <div class="form-group">
                <label class="form-label">카테고리 *</label>
                <div class="category-buttons">
                    <button type="button" class="category-btn active" data-value="공지">공지</button>
                    <button type="button" class="category-btn" data-value="이벤트">이벤트</button>
                    <button type="button" class="category-btn" data-value="업데이트">업데이트</button>
                    <button type="button" class="category-btn" data-value="점검">점검</button>
                </div>
                <input type="hidden" name="categoryString" id="categoryString" value="공지">
            </div>

            <!-- 중요 공지 체크박스 -->
            <div class="form-group checkbox-group">
                <input type="checkbox" id="important" name="important" class="form-checkbox">
                <label for="important" class="checkbox-label">중요 공지로 표시 (상단 고정)</label>
            </div>

            <!-- 내용 -->
            <div class="form-group">
                <label class="form-label">내용 *</label>
                <textarea name="content" class="form-textarea" rows="10" placeholder="공지사항 내용을 입력하세요" required></textarea>
                <p class="form-hint">* 줄바꿈은 자동으로 적용됩니다</p>
            </div>

            <!-- 버튼 영역 -->
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="location.href='/notice'">취소</button>
                <button type="submit" class="btn-submit">작성</button>
            </div>
        </div>
    </form>
</div>
<th:block layout:fragment="script">
<script>
    window.addEventListener('load', function () {
        $(document).ready(function() {

            // 카테고리 선택
            const categoryButtons = document.querySelectorAll('.category-btn');
            const selected = document.getElementById('categoryString');

            categoryButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                categoryButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selected.value = btn.dataset.value;
                });
            });

            const token = $('meta[name="_csrf"]').attr('content');
            const header = $('meta[name="_csrf_header"]').attr('content');
            
            // 폼 submit
            $('#noticeForm').on('submit', function(e) {
                e.preventDefault();

                const payload = {
                title: $('input[name="title"]').val(),
                content: $('textarea[name="content"]').val(),
                categoryString: $('#categoryString').val(),
                important: $('#important').is(':checked')
                };

                $.ajax({
                    url: '/admin/api/notice/create',
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8', 
                    dataType: 'json',                                
                    data: JSON.stringify(payload),      
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader(header, token)
                    },
                    success: function(res) {
                        window.location.href = '/notice/' + res;
                    },
                    error: function(xhr) {
                        console.error(xhr.responseText);
                        alert('등록 실패');
                    }
                });
            });
        });
    });
</script>
</th:block>

</body>
</html>
