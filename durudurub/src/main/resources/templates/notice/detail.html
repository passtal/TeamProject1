<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{/layouts/main_layout}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title th:text="${notice.title} + ' - 두루두룹'">공지사항 상세</title>
    <link rel="stylesheet" th:href="@{/css/notice/notice-detail.css}">
</head>
<body layout:fragment="content">

<!-- 상단 버튼 -->
<div class="notice-actions">
    <div class="actions-container">
        <!-- 목록으로 버튼 -->
        <a href="/notice" class="btn-list">
            <span class="material-symbols-outlined">arrow_back</span>
            <span>목록으로</span>
        </a>

        <!-- 관리자 버튼 -->
        <div class="admin-buttons" sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/admin/notice/update/{noticeNo}(noticeNo=${notice.noticeNo})}" class="btn-edit">
                <span class="material-symbols-outlined">edit</span>
                <span>수정</span>
            </a>
            <button type="button" class="btn-delete" onclick="openDeleteModal()">
                <span class="material-symbols-outlined">delete</span>
                <span>삭제</span>
            </button>
        </div>
    </div>
</div>

<div class="notice-detail-page">
    <div class="notice-detail-container">
        <!-- 태그 -->
        <div class="notice-tags">
            <span th:each="tag : ${#strings.arraySplit(notice.categoryString, ',')}" 
                  th:class="'tag ' + ${
                            tag == '공지' ? 'tag-notice' :
                            tag == '이벤트' ? 'tag-event' :
                            tag == '업데이트' ? 'tag-update' :
                            tag == '점검' ? 'tag-maintenance' : 'tag-notice'
                            }"
                  th:text="${tag}">태그</span>
            <span th:if="${notice.important}" class="notice-tag tag-important">중요</span>
        </div>

        <!-- 제목 -->
        <h1 class="notice-title" th:text="${notice.title}"></h1>

        <!-- 메타 정보 -->
        <div class="notice-meta">
            <div class="meta-item">
                <span class="material-symbols-outlined">calendar_today</span>
                <span th:text="${#temporals.format(notice.regDate, 'yyyy-MM-dd')}"></span>
            </div>
            <div class="meta-item">
                <span class="material-symbols-outlined">visibility</span>
                <span th:text="'조회 ' + ${#numbers.formatInteger(notice.views, 0, 'COMMA')}"></span>
            </div>
        </div>

        <!-- 내용 -->
        <div class="notice-content" th:text="${notice.content}">
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <!-- 경고 아이콘 -->
        <div class="modal-icon">
            <span i class="material-symbols-outlined icon-large">delete</span>
        </div>
        
        <!-- 모달 제목 -->
        <h3 class="modal-title">공지사항을 삭제하시겠습니까?</h3>
        
        <!-- 모달 설명 -->
        <p class="modal-description">삭제된 공지사항은 복구할 수 없습니다.</p>
        
        <!-- 모달 버튼 -->
        <div class="modal-buttons">
            <button type="button" class="modal-btn-cancel" onclick="closeDeleteModal()">취소</button>
            <button type="button" class="modal-btn-delete" th:onclick="'deleteNotice(' + ${notice.noticeNo} + ')'">삭제</button>
        </div>
        
        <!-- 닫기 버튼 -->
        <button type="button" class="modal-close" onclick="closeDeleteModal()">
            <span class="material-symbols-outlined">close</span>
        </button>
    </div>
</div>

<script>
    // 모달 열기
    function openDeleteModal() {
        document.getElementById('deleteModal').style.display = 'flex';
        document.body.style.overflow = 'hidden'; // 스크롤 막기
    }

    // 모달 닫기
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        document.body.style.overflow = 'auto'; // 스크롤 복원
    }

    // 삭제 실행
    function deleteNotice(noticeNo) {
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        $.ajax({
        url: '/admin/api/notice/' + noticeNo,
        type: 'DELETE',
        beforeSend: function (xhr) {
            xhr.setRequestHeader(header, token);
        },
        success: function (res) {
            // res가 1이면 성공(보통)
            alert('공지사항이 삭제되었습니다.');
            window.location.href = '/notice';
        },
        error: function (xhr) {
            console.error(xhr.responseText);
            alert('삭제 중 오류가 발생했습니다.');
        }
        });
    }


    // 모달 배경 클릭 시 닫기
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
</script>

</body>
</html>
