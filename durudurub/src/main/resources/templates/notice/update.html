<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{/layouts/main_layout}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>공지사항 수정 - 두루두룹</title>
    <link rel="stylesheet" th:href="@{/css/notice/notice-update.css}">
</head>
<body layout:fragment="content">

<!-- 상단 헤더 -->
<div class="notice-header">
    <div class="header-container">
        <a href="javascript:history.back();" class="btn-back">
            <span class="material-symbols-outlined">keyboard_backspace</span>
        </a>
        <h1 class="page-title">공지사항 수정</h1>
    </div>
</div>

<div class="notice-update-page">

    <!-- 폼 컨테이너 -->
    <form id="noticeUpdateForm" class="notice-form">
        <div class="form-content">
            <!-- 제목 -->
            <div class="form-group">
                <label class="form-label">제목 *</label>
                <input type="text" name="title" class="form-input" th:value="${notice.title}" placeholder="공지사항 제목을 입력하세요" required>
            </div>

            <!-- 카테고리 -->
            <div class="form-group">
                <label class="form-label">카테고리 *</label>
                <div class="category-buttons">
                    <button type="button" class="category-btn" data-value="공지" 
                            th:classappend="${notice.categoryString == '공지'} ? ' active' : ''">공지</button>
                    <button type="button" class="category-btn" data-value="이벤트"
                            th:classappend="${notice.categoryString == '이벤트'} ? ' active' : ''">이벤트</button>
                    <button type="button" class="category-btn" data-value="업데이트"
                            th:classappend="${notice.categoryString == '업데이트'} ? ' active' : ''">업데이트</button>
                    <button type="button" class="category-btn" data-value="점검"
                            th:classappend="${notice.categoryString == '점검'} ? ' active' : ''">점검</button>
                </div>
                <input type="hidden" name="categoryString" id="categoryString" th:value="${notice.categoryString}">
            </div>

            <!-- 중요 공지 체크박스 -->
            <div class="form-group checkbox-group">
                <input type="checkbox" id="important" name="important" class="form-checkbox" th:checked="${notice.important}">
                <label for="important" class="checkbox-label">중요 공지로 표시 (상단 고정)</label>
            </div>

            <!-- 내용 -->
            <div class="form-group">
                <label class="form-label">내용 *</label>
                <textarea name="content" class="form-textarea" rows="10" th:text="${notice.content}" placeholder="공지사항 내용을 입력하세요" required></textarea>
                <p class="form-hint">* 줄바꿈은 자동으로 적용됩니다</p>
            </div>

            <!-- 버튼 영역 -->
            <div class="form-actions">
                <button type="button" class="btn-cancel" th:onclick="|location.href='/notice/${notice.noticeNo}'|">취소</button>
                <button type="submit" class="btn-submit">수정</button>
            </div>
        </div>
    </form>
</div>
<th:block layout:fragment="script">
<script th:inline="javascript">
    window.addEventListener('load', function () {
        $(document).ready(function() {

        // 카테고리 선택
        const categoryButtons = document.querySelectorAll('.category-btn');
        const selected = document.getElementById('categoryString');

        categoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
            categoryButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selected.value = btn.dataset.value;
            });
        });

        const token = $('meta[name="_csrf"]').attr('content');
        const header = $('meta[name="_csrf_header"]').attr('content');

        const noticeNo = [[${notice.noticeNo}]];

        $('#noticeUpdateForm').on('submit', function(e) {
            e.preventDefault();

            const payload = {
            title: $('input[name="title"]').val(),
            content: $('textarea[name="content"]').val(),
            categoryString: $('#categoryString').val(),
            important: $('#important').is(':checked')
            };

            $.ajax({
            url: '/admin/api/notice/' + noticeNo + '/update',
            type: 'PUT',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(payload),
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(res) {
                // res가 1(성공)이면 상세로
                window.location.href = '/notice/' + noticeNo;
            },
            error: function(xhr) {
                console.error(xhr.responseText);
                alert('수정 실패');
            }
            });
        });
    });
});
</script>
</th:block>


</body>
</html>
