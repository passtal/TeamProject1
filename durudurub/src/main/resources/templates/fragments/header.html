<!-- 헤더 fragment -->
<!-- TODO: 구현 -->

<!-- 추가할 것
    1. 로그인 전/후
    2. 로그인 후 user/admin 드롭다운
    3. 모바일용 아이콘 -->

<th:block th:fragment="header">
  <header class="header">
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom" th:href="@{/}">
      <div class="container-fluid">
          <!-- 모바일 햄버거 버튼 -->
          <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu" aria-controls="mobileMenu">
              <span class="navbar-toggler-icon"></span>
          </button>
          
          <!-- 두루두룹로고 -->
          <a class="navbar-brand d-flex align-items-center gap-1" href="/">
              <img th:src="@{/img/icons/logo-durup.png}" alt="두루두룹 로고" class="logo-img" width="40" height="40">
              <span class="fw-bold fs-5 d-none d-sm-inline">두루두룹</span>
          </a>
          <!-- 검색창 영역 (중앙) - 데스크탑만 -->
          <div class="search-container w-50 d-none d-lg-block mx-auto">
              <form class="d-flex justify-content-center" role="search" th:action="@{/club/list}" method="get">
                  <div class="input-group club-search-group">
                      <button class="btn btn-outline-secondary left-btn" type="submit">     
                        <img th:src="@{/img/icons/navbar-search-icon.png}" alt="검색" class="navbar-icon">
                      </button>
                      <input class="form-control rounded-pill shadow-none" type="search" name="keyword" placeholder="모임 검색..." aria-label="Search" style="padding-left: 50px;">
                      <button class="btn btn-outline-secondary right-btn ai-search-btn" type="button">
                        <img th:src="@{/img/icons/navbar-filter-button.png}" alt="ai검색" class="navbar-icon">
                      </button>
                  </div>
              </form>
          </div>
          
          <!-- 오른쪽 영역 - 데스크탑 -->
          <div class="navbar-right d-none d-lg-flex">
              <a th:href="@{/game/list}" class="minigameIcon btn btn-outline-success rounded-pill">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gamepad2 lucide-gamepad-2 w-5 h-5"><line x1="6" x2="10" y1="11" y2="11"></line><line x1="8" x2="8" y1="9" y2="13"></line><line x1="15" x2="15.01" y1="12" y2="12"></line><line x1="18" x2="18.01" y1="10" y2="10"></line>
                    <path d="M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.545-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.151A4 4 0 0 0 17.32 5z"></path>
                </svg>
                미니게임
              </a>
              <!-- 로그인 전후 -->
              <!-- 비로그인 -->
              <th:block sec:authorize="isAnonymous()">
                <a th:href="@{/join}" class="minigameIcon btn btn-outline-success rounded-pill">회원가입</a>
                <a th:href="@{/login}" class="minigameIcon btn btn-outline-success rounded-pill">로그인</a>
              </th:block>
              <!-- 로그인 후 : user -->
              <th:block sec:authorize="( hasRole('USER') )">
                  <div class="icon-container">
                      <button class="btn btn-link p-0" type="button">
                          <img th:src="@{/img/icons/navbar-notification.png}" alt="알림" class="user-icon">
                      </button>
                      <div id="user-dropdown" class="hidden" style="display: none;">
                          <ul>
                              <li><a th:href="@{/users/mypage}" class="mypage">마이페이지</a></li>
                              <li><a th:href="@{/users/mypage/club}" class="myclub">내모임</a></li>
                              <hr>
                              <li>
                                  <form th:action="@{/logout}" method="post" style="display:inline;">
                                      <button type="submit" class="logout btn btn-link p-0">로그아웃</button>
                                  </form>
                              </li>
                          </ul>
                      </div>
                  </div>
              </th:block>
              <!-- 로그인 후 : admin -->
              <th:block sec:authorize="( hasRole('ADMIN') )">
                  <div class="icon-container">
                      <button class="btn btn-link p-0" type="button">
                          <img th:src="@{/img/icons/navbar-notification.png}" alt="알림" class="user-icon">
                      </button>
                      <div id="admin-dropdown" class="hidden">
                          <ul>
                            <li class="notice">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell w-5 h-5" data-fg-cqpb125="597.340:597.21274:/src/app/components/Navbar.tsx:354:27:13175:28:e:Bell::::::CiHR">
                                    <path d="M10.268 21a2 2 0 0 0 3.464 0"></path>
                                    <path d="M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326"></path>
                                </svg>
                                <a th:href="@{/admin/notice}" class="notice">공지사항</a>
                            </li>
                              <li><a th:href="@{/admin/}" class="adminpage" style="color: blueviolet;">관리자 페이지</a></li>
                              <!-- <br style="color: #374151;"> -->
                              <li>
                                  <form th:action="@{/logout}" method="post" style="display:inline;">
                                      <button type="submit" class="logout btn btn-link p-0">로그아웃</button>
                                  </form>
                              </li>
                          </ul>
                      </div>
                  </div>
              </th:block>
          </div>
          
          <!-- 모바일 알림/프로필 아이콘 -->
          <div class="d-lg-none d-flex align-items-center gap-2">
              <th:block sec:authorize="isAuthenticated()">
                  <button class="btn btn-link p-0" type="button">
                      <img th:src="@{/img/icons/navbar-notification.png}" alt="알림" class="user-icon" width="24" height="24">
                  </button>
              </th:block>
          </div>
      </div>
    </nav>
  </header>
  
  <!-- 모바일 오프캔버스 메뉴 -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu" aria-labelledby="mobileMenuLabel">
      <div class="offcanvas-header border-bottom">
          <a class="navbar-brand d-flex align-items-center gap-2" href="/" data-bs-dismiss="offcanvas">
              <img th:src="@{/img/icons/logo-durup.png}" alt="두루두룹 로고" width="40" height="40">
              <span class="fw-bold fs-5">두루두룹</span>
          </a>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
          <!-- 모바일 검색 -->
          <form class="mb-4" role="search" th:action="@{/club/list}" method="get">
              <div class="input-group">
                  <input class="form-control rounded-pill" type="search" name="keyword" placeholder="모임 검색..." aria-label="Search">
                  <button class="btn btn-success rounded-pill ms-2" type="submit">
                      <i class="bi bi-search"></i>
                  </button>
              </div>
          </form>
          
          <!-- 메뉴 리스트 -->
          <ul class="nav flex-column">
              <li class="nav-item">
                  <a class="nav-link d-flex align-items-center gap-2 py-3" th:href="@{/club/list}" data-bs-dismiss="offcanvas">
                      <i class="bi bi-people fs-5"></i>
                      <span>모임 둘러보기</span>
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link d-flex align-items-center gap-2 py-3" th:href="@{/game/list}" data-bs-dismiss="offcanvas">
                      <i class="bi bi-controller fs-5"></i>
                      <span>미니게임</span>
                  </a>
              </li>
              
              <hr class="my-2">
              
              <!-- 비로그인 -->
              <th:block sec:authorize="isAnonymous()">
                  <li class="nav-item">
                      <a class="nav-link d-flex align-items-center gap-2 py-3" th:href="@{/login}" data-bs-dismiss="offcanvas">
                          <i class="bi bi-box-arrow-in-right fs-5"></i>
                          <span>로그인</span>
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link d-flex align-items-center gap-2 py-3" th:href="@{/join}" data-bs-dismiss="offcanvas">
                          <i class="bi bi-person-plus fs-5"></i>
                          <span>회원가입</span>
                      </a>
                  </li>
              </th:block>
              
              <!-- 로그인 후 : user -->
              <th:block sec:authorize="hasRole('USER')">
                  <li class="nav-item">
                      <a class="nav-link d-flex align-items-center gap-2 py-3" th:href="@{/users/mypage}" data-bs-dismiss="offcanvas">
                          <i class="bi bi-person fs-5"></i>
                          <span>마이페이지</span>
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link d-flex align-items-center gap-2 py-3" th:href="@{/users/mypage/club}" data-bs-dismiss="offcanvas">
                          <i class="bi bi-heart fs-5"></i>
                          <span>내 모임</span>
                      </a>
                  </li>
                  <hr class="my-2">
                  <li class="nav-item">
                      <form th:action="@{/logout}" method="post">
                          <button type="submit" class="nav-link d-flex align-items-center gap-2 py-3 text-danger w-100 border-0 bg-transparent">
                              <i class="bi bi-box-arrow-right fs-5"></i>
                              <span>로그아웃</span>
                          </button>
                      </form>
                  </li>
              </th:block>
              
              <!-- 로그인 후 : admin -->
              <th:block sec:authorize="hasRole('ADMIN')">
                  <li class="nav-item">
                      <a class="nav-link d-flex align-items-center gap-2 py-3" th:href="@{/admin/notice}" data-bs-dismiss="offcanvas">
                          <i class="bi bi-megaphone fs-5"></i>
                          <span>공지사항</span>
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link d-flex align-items-center gap-2 py-3" th:href="@{/admin}" data-bs-dismiss="offcanvas">
                          <i class="bi bi-gear fs-5"></i>
                          <span>관리자 페이지</span>
                      </a>
                  </li>
                  <hr class="my-2">
                  <li class="nav-item">
                      <form th:action="@{/logout}" method="post">
                          <button type="submit" class="nav-link d-flex align-items-center gap-2 py-3 text-danger w-100 border-0 bg-transparent">
                              <i class="bi bi-box-arrow-right fs-5"></i>
                              <span>로그아웃</span>
                          </button>
                      </form>
                  </li>
              </th:block>
          </ul>
      </div>
  </div>

  <!-- AI 검색 로그인 필요 팝업 (비로그인 시) -->
  <div class="modal fade" id="aiLoginModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content text-center p-4">
              <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
              <div class="mb-3 mt-2">
                  <img th:src="@{/img/icons/navbar-filter-button.png}" alt="AI" width="60" height="60">
              </div>
              <h5 class="fw-bold">로그인이 필요합니다</h5>
              <p class="text-muted small">
                  AI 검색 기능은 로그인 후 이용하실 수 있습니다.<br>
                  로그인하시면 무료로 3회까지 AI 검색을 체험하실 수 있어요!
              </p>
              <div class="mb-3 text-start mx-auto" style="max-width: 280px;">
                  <p class="fw-bold text-center mb-2">AI 검색으로 이런 것들이 가능해요</p>
                  <p class="text-success small mb-1">✓ 자연어로 원하는 모임 찾기</p>
                  <p class="text-success small mb-1">✓ 맞춤형 모임 추천받기</p>
                  <p class="text-success small mb-0">✓ 로그인 후 무료 3회 체험</p>
              </div>
              <div class="d-flex gap-2 justify-content-center mt-3">
                  <button class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">취소</button>
                  <a th:href="@{/login}" class="btn px-4 text-white" style="background-color: #8B5CF6;">로그인하기</a>
              </div>
          </div>
      </div>
  </div>

  <!-- AI 검색 구독 필요 팝업 (무료 3회 소진 시) -->
  <div class="modal fade" id="aiSubscribeModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content text-center p-4">
              <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
              <div class="mb-3 mt-2">
                  <img th:src="@{/img/icons/navbar-filter-button.png}" alt="AI" width="60" height="60">
              </div>
              <h5 class="fw-bold">무료 체험이 종료되었습니다</h5>
              <p class="text-muted small">
                  무료 AI 검색 3회를 모두 사용하셨습니다.<br>
                  프리미엄 구독 후 무제한으로 AI 검색을 이용해보세요!
              </p>
              <div class="mb-3 text-start mx-auto" style="max-width: 280px;">
                  <p class="fw-bold text-center mb-2">프리미엄 구독 혜택</p>
                  <p class="text-success small mb-1">✓ AI 검색 무제한 이용</p>
                  <p class="text-success small mb-1">✓ 맞춤형 모임 추천</p>
                  <p class="text-success small mb-0">✓ 우선 검색 결과 노출</p>
              </div>
              <div class="d-flex gap-2 justify-content-center mt-3">
                  <button class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">취소</button>
                  <a th:href="@{/payments}" class="btn px-4 text-white" style="background-color: #8B5CF6;">구독하기</a>
              </div>
          </div>
      </div>
  </div>

  <!-- AI 검색 모달 (로그인 + 검색 가능 시) -->
  <div class="modal fade" id="aiSearchModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-robot"></i> AI 모임 검색
                      <span id="aiSearchRemaining" class="badge bg-secondary ms-2" style="font-size: 0.7rem;"></span>
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="aiSearchForm">
                      <div class="input-group mb-3">
                          <input type="text" id="aiSearchInput" class="form-control"
                                 placeholder="예: 서울에서 등산 같이 할 사람 있나요?">
                          <button class="btn btn-primary" type="submit">
                              <i class="bi bi-search"></i> 검색
                          </button>
                      </div>
                  </form>
                  <div id="aiSearchResult">
                      <p class="text-muted text-center py-4">
                          자연어로 원하는 모임을 검색해보세요!
                      </p>
                  </div>
              </div>
          </div>
      </div>
  </div>
</th:block>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 검색창 엔터키 기능
    const searchInput = document.querySelector('input[name="keyword"]');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const form = this.closest('form');
                if (form) {
                    form.submit();
                }
            }
        });
    }

    // 사용자 드롭다운 토글
    const userIcons = document.querySelectorAll('.icon-container > button');
    userIcons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const dropdown = this.nextElementSibling;
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
        });
    });

    // 페이지 다른 곳 클릭시 드롭다운 닫기
    document.addEventListener('click', function(e) {
        const iconContainers = document.querySelectorAll('.icon-container');
        iconContainers.forEach(container => {
            if (!container.contains(e.target)) {
                const dropdown = container.querySelector('[style*="display"]');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }
        });
    });
});
</script>
