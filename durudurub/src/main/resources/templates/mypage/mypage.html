<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/main_layout}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>마이페이지 - 두루두룹</title>
    <link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">
    <link rel="stylesheet" th:href="@{/css/mypage/mypage-edit.css}">
</head>
<body layout:fragment="content">

<div class="mypage-container">
    <!-- 왼쪽 컬럼 -->
    <div class="left-column">
        <!-- 멤버십 정보 카드 -->
        <!-- ⭐ 구독 전후 구분 -->
        <div class="membership-card" th:classappend="${subscription?.status == 'ACTIVE'} ? ' is-premium' : ''">
            <div class="membership-decorations">
                <div class="decoration-circle circle-1"></div>
                <div class="decoration-circle circle-2"></div>
            </div>
            <div class="membership-content">
                <div class="membership-header">
                    <h3 class="section-title">멤버십 정보</h3>
                    <span class="material-symbols-outlined membership-icon">stars</span>
                </div>
                <!-- 현재 계정의 구독 여부 확인 합니다! -->
                <div class="membership-body">
                    <div class="membership-badge">
                        <span class="badge-free" th:text="${subscription?.status == 'ACTIVE'} ? 'PREMIUM' : 'FREE'">FREE</span>
                    </div>
                    <!-- 구독 중이면 왼쪽 텍스트 노출 구독 아니면 오른쪽 텍스트 노출 -->
                    <p class="membership-description" th:text="${subscription?.status == 'ACTIVE'} ? '프리미엄 구독 이용중입니다' : '무료 플랜을 이용하고 계십니다'">무료 플랜을 이용하고 계십니다</p>
                    <div class="membership-dates" th:if="${subscription?.status == 'ACTIVE'}">
                        <div class="membership-date">
                            <span class="date-label">시작일</span>
                            <span class="date-value" th:text="${#dates.format(subscription.startDate, 'yyyy년 M월 d일')}">-</span>
                        </div>
                        <div class="membership-date">
                            <span class="date-label">종료일</span>
                            <span class="date-value" th:text="${#dates.format(subscription.endDate, 'yyyy년 M월 d일')}">-</span>
                        </div>
                    </div>

                    <!-- 구독 중이면 왼쪽 텍스트 노출 구독 아니면 오른쪽 텍스트 노출 -->
                    <div class="membership-features">
                        <div class="feature-item">
                            <span class="feature-dot"></span>
                            <span class="feature-text" th:text="${subscription?.status == 'ACTIVE'} ? '제한 없는 AI 검색' : 'AI 검색 3회 제한'">AI 검색 3회 제한</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-dot"></span>
                            <span class="feature-text" th:text="${subscription?.status == 'ACTIVE'} ? '광고 없는 깨끗한 환경' : '광고 노출'">광고 노출</span>
                        </div>
                    </div>
                    <!-- 구독 중이면 구독하기 버튼 없어집니다! -->
                    <a class="btn-premium" th:href="@{/payments}" th:if="${subscription?.status != 'ACTIVE'}">프리미엄 구독하기</a>
                </div>
            </div>
        </div>

        <!-- 멤버십 구독 전후 구분 끝! -->

        <!-- 기본 정보 카드 -->
        <div class="info-card">
            <!-- 읽기 모드 헤더 -->
            <div class="card-header" id="view-mode">
                <h2 class="card-title">기본 정보</h2>
                <button class="btn-edit-icon" id="btnEditMode" onclick="updateBtn()">
                    <span class="material-symbols-outlined">edit</span>
                    <span>수정</span>
                </button>
            </div>
            
            <!-- 수정 모드 헤더 -->
            <div class="card-header" id="edit-mode" style="display: none;">
                <h2 class="card-title">기본 정보</h2>
                <div class="edit-actions">
                    <button class="btn-cancel" id="btnCancelEdit" onclick="cancelBtn()">취소</button>
                    <button class="btn-save" id="btnSaveEdit" onclick="saveBtn()">저장</button>
                </div>
            </div>
            
            <!-- 읽기 모드 -->
            <div class="info-content" id="view-content">
                <!-- 프로필 이미지 -->
                <div class="profile-section">
                    <div class="profile-avatar">
                        <img th:src="${user?.profileImg != null ? user.profileImg : '/img/default-profile.png'}" 
                             src="/img/default-profile.png"
                             alt="프로필 이미지" 
                             class="profile-image"
                             id="profileImageView">
                    </div>
                </div>

                <!-- 기본 정보 카드 -->
                <div class="info-card"  th:object="${user}">
                    <!-- 읽기 모드 헤더 -->
                    <div class="card-header" id="view-mode">
                        <h2 class="card-title">기본 정보</h2>
                        <button class="btn-edit-icon" id="btnEditMode" onclick="updateBtn()">
                            <span class="material-symbols-outlined">edit</span>
                            <span>수정</span>
                        </button>
                    </div>
                    
                    <!-- 수정 모드 헤더 -->
                    <div class="card-header" id="edit-mode" style="display: none;">
                        <h2 class="card-title">기본 정보</h2>
                        <div class="edit-actions">
                            <button class="btn-cancel" id="btnCancelEdit" onclick="cancelBtn()">취소</button>
                            <button class="btn-save" id="btnSaveEdit" onclick="saveBtn()">저장</button>
                        </div>
                    </div>
                    
                    <!-- 읽기 모드 -->
                    <div class="info-content" id="view-content">
                        <!-- 프로필 이미지 -->
                        <div class="profile-section">
                            <div class="profile-avatar">
                                <!-- ⭐ 이미지 데이터 받기 -->
                                <img th:src="${user.profileImg != null ? user.profileImg : '/img/두룹이/두룹이만세.png'}"
                                    alt="프로필 이미지"
                                    class="profile-image"
                                    id="profileImageView" />
                            </div>
                        </div>

                        <!-- 정보 필드들 -->
                        <div class="info-fields">
                            <!-- 닉네임 -->
                            <div class="info-field">
                                <label class="field-label">
                                    <span class="material-symbols-outlined">person</span>
                                    <span>닉네임</span>
                                </label>
                                <div class="field-value">
                                    <span id="username-span" th:text="*{username != null ? username : '미입력'}"></span>
                                </div>
                            </div>

                            <!-- 이메일 -->
                            <div class="info-field">
                                <label class="field-label">
                                    <span class="material-symbols-outlined">mail</span>
                                    <span>이메일</span>
                                </label>
                                <div class="field-value readonly-field">
                                    <span id="userid-span" th:text="*{userId}"></span>
                                </div>
                            </div>

                            <!-- 활동 지역 -->
                            <div class="info-field">
                                <label class="field-label">
                                    <span class="material-symbols-outlined">location_on</span>
                                    <span>활동 지역</span>
                                </label>
                                <div class="field-value field-value-placeholder">
                                    <span id="useraddress-span" th:text="*{address != null ? address : '미입력'}"></span>
                                </div>
                            </div>

                            <!-- 나이 & 성별 -->
                            <div class="info-field-row">
                                <div class="info-field info-field-half">
                                    <label class="field-label">
                                        <span class="material-symbols-outlined">person</span>
                                        <span>나이</span>
                                    </label>
                                    <div class="field-value field-value-placeholder">
                                        <span id="userage-span" th:text="*{age != null ? age + '세' : '미입력'}"></span>
                                    </div>
                                </div>
                                <div class="info-field info-field-half">
                                    <label class="field-label">
                                        <span class="material-symbols-outlined">person</span>
                                        <span>성별</span>
                                    </label>
                                    <div class="field-value">
                                        <span id="usergender-span" th:text="*{gender != null ? gender : '선택 안함'}"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 가입일 -->
                            <div class="info-field">
                                <label class="field-label">
                                    <span class="material-symbols-outlined">calendar_today</span>
                                    <span>가입일</span>
                                </label>
                                <div class="field-value readonly-field">
                                    <span th:text="*{ #dates.format( createdAt, 'yyyy년 MM월 dd일') }"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 수정 모드 -->
                    <div class="info-content" id="edit-content" style="display: none;">
                        <!-- ⭐ 프로필 이미지 수정 -->
                        <div class="profile-section-edit">
                            <div class="profile-avatar-edit">
                                <img th:src="${user.profileImg != null ? user.profileImg : '/img/default-profile.png'}"
                                alt="프로필 이미지"
                                class="profile-image-edit"
                                id="profileImageEdit" />
                            </div>
                            <button  type="button" class="btn-change-photo" id="btnChangePhoto">
                                <span class="change-photo-text">사진 변경</span>
                            </button>
                            <input type="file"
                                id="profileImg"
                                name="profileImg"
                                accept="image/*"
                                style="display:none;" />
                        </div>

                        <!-- 정보 입력 필드들 -->
                        <div class="info-fields-edit">
                            <!-- 닉네임 -->
                            <div class="info-field-edit">
                                <label class="field-label-edit">
                                    <!-- ⭐ 닉네임 중복체크 유효성 검사 -->
                                    <span class="material-symbols-outlined">person</span>
                                    <span>닉네임</span>
                                </label>
                                <input type="text" 
                                    class="field-input" 
                                    id="username-input" 
                                    th:value="*{username}" 
                                    value="test"
                                    placeholder="예: 두루두룹">
                            </div>

                            <!-- 이메일 (읽기 전용) -->
                            <div class="info-field-edit">
                                <label class="field-label-edit">
                                    <span class="material-symbols-outlined">mail</span>
                                    <span>이메일</span>
                                </label>
                                <div class="field-input-readonly">
                                    <span id="userid-span" th:text="*{userId}"></span>
                                </div>
                            </div>

                            <!-- 활동 지역 -->
                            <div class="info-field-edit">
                                <label class="field-label-edit">
                                    <span class="material-symbols-outlined">location_on</span>
                                    <span>활동 지역</span>
                                </label>
                                <input type="text" 
                                    class="field-input" 
                                    id="useraddress-input" 
                                    th:value="*{address}"
                                    placeholder="예: 서울특별시">
                            </div>

                            <!-- 나이 & 성별 -->
                            <div class="info-field-row-edit">
                                <div class="info-field-edit info-field-half-edit">
                                    <label class="field-label-edit">
                                        <!-- ⭐ 나이 유효성 검사 -->
                                        <span class="material-symbols-outlined">person</span>
                                        <span>나이</span>
                                    </label>
                                    <div class="age-input-group">
                                        <input type="number" 
                                            class="field-input field-input-number" 
                                            id="userage-input" 
                                            th:value="*{age}" 
                                            placeholder="예: 25"
                                            min="15"
                                            max="100">
                                        <span class="age-suffix">세</span>
                                    </div>
                                </div>
                                <div class="info-field-edit info-field-half-edit">
                                    <label class="field-label-edit">
                                        <span class="material-symbols-outlined">person</span>
                                        <span>성별</span>
                                    </label>
                                    <select class="field-select" id="usergender-select" th:value="*{gender}">
                                        <option value="">선택 안함</option>
                                        <option value="남성" th:selected="*{gender == '남성'}">남성</option>
                                        <option value="여성" th:selected="*{gender == '여성'}">여성</option>
                                        <option value="기타" th:selected="*{gender == '기타'}">기타</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 가입일 (읽기 전용) -->
                            <div class="info-field-edit">
                                <label class="field-label-edit">
                                    <span class="material-symbols-outlined">calendar_today</span>
                                    <span>가입일</span>
                                </label>
                                <div class="field-input-readonly">
                                    <span th:text="*{ #dates.format( createdAt, 'yyyy년 MM월 dd일') }">2025년 1월 20일</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 활동 통계 카드 -->
                <div class="stats-card">
                    <h2 class="card-title">활동 통계</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-content">
                                <div class="stat-info">
                                    <p class="stat-label">참여 중인 모임</p>
                                    <p class="stat-value" th:text="${totalMyClub} + '개'">0개</p>
                                </div>
                                <span class="material-symbols-outlined stat-icon">groups</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-content">
                                <div class="stat-info">
                                    <p class="stat-label">즐겨찾기</p>
                                    <p class="stat-value">5개</p>
                                </div>
                                <span class="material-symbols-outlined stat-icon">favorite</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 오른쪽 컬럼 -->
            <div class="right-column">
                <!-- 빠른 메뉴 카드 -->
                <div class="quick-menu-card">
                    <h3 class="section-title">빠른 메뉴</h3>
                    <div class="menu-list">
                        <a th:href="@{/users/mypage/club}" class="menu-item">내 모임 관리</a>
                        <a th:href="@{/users/mypage/favorites}" class="menu-item">즐겨찾기 목록</a>
                    </div>
                </div>

                <!-- 계정 관리 카드 -->
                <div class="account-card">
                    <h3 class="section-title">계정 관리</h3>
                    <button id="deleteAccountBtn" class="menu-item menu-item-danger" onclick="openModal()">회원 탈퇴</button>
                </div>
            </div>
        </div>

        <!-- 회원 탈퇴 모달 -->
        <div id="delete-modal" class="modal" >
            <div class="modal-content" >
                <div class="modal-header">
                    <div class="icon-wrapper">
                        <span class="material-symbols-outlined error-icon">warning</span>
                    </div>
                </div>
                <h2 class="modal-title">회원 탈퇴</h2>
                <p class="modal-text">회원 탈퇴하면 되돌릴 수 없습니다.</p>
                <p class="modal-text">정말 탈퇴하시겠습니까?</p>
                <div class="modal-actions">
                    <button id="cancelBtn" class="modal-btn modal-btn-cancel" onclick="closeModal()">취소</button>
                    <button id="confirmDeleteBtn" class="modal-btn modal-btn-delete" onclick="userDelete()">탈퇴하기</button>
                </div>
            </div>
        </div>
    </main>

    <!-- static/js/userpage.js 정적 경로 -->
    <th:block layout:fragment="script">
    <script>
    // 회원 정보 수정 (수정버튼)
    function updateBtn() {
        $("#view-mode, #view-content").hide() // 조회 화면 -> span
        $("#edit-mode, #edit-content").show() // 수정 화면 -> text

        // .trim() : 공백 입력 방지!
        //          option '여자' -> span ' 여자 ' : 적용X
        $("#username-input").val($("#username-span").text().trim())
        $("#useraddress-input").val($("#useraddress-span").text().trim())
        // 나이 : "세" 추가하기
        // "" : "세" -> "" (숫자만 뽑기)
        const ageText = $("#userage-span").text().replace("세", "").trim()
        $("#userage-input").val(ageText);
        // 성별 : 선택 안함 추가하기
        const genderText = $("#usergender-span").text().trim()
        $("#usergender-select").val(genderText === "선택 안함" ? "" : genderText)

        // 사진 미리보기 기존 값 설정
        $("#profileImageEdit").attr("src", $("#profileImageView").attr("src"));
    }

    // 회원 정보 수정 (취소버튼)
    function cancelBtn() {
        $("#edit-mode, #edit-content").hide() // 수정 화면 -> text
        $("#view-mode, #view-content").show() // 조회 화면 -> span
    }

    // 회원 정보 수정 (저장버튼)
    function saveBtn() {

        // 사진 추가 시 FormData 필요!
        const formData = new FormData();

        formData.append("username", $("#username-input").val());
        // "세" 추가하기
        const ageVal = $("#userage-input").val()
        formData.append("age", ageVal ? parseInt(ageVal, 10) : 0);
        
        formData.append("gender", $("#usergender-select").val());
        formData.append("address", $("#useraddress-input").val());

        // CSRF 토큰 문제 (403)
        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");

        // 사진이 선택된 경우에만 추가
        const imgFile = $("#profileImg")[0].files[0];
        if (imgFile) {
            formData.append("profileImg", imgFile);
        }

        $.ajax({
            url: `/users/mypage`,
            method: 'POST',
            processData: false,  // processData: false → 데이터를 문자열로 변환하지 않고 원본 그대로 보냄
            contentType: false,  // contentType: false → 헤더를 자동으로 설정하지 말고, 브라우저가 알아서 content-type 붙게 비워두기
            data: formData,      // data: formData → 여기에 실제로 보낼 데이터 (formData 객체) 들어있음
            beforeSend: function (xhr) {    // CSRF 토큰 문제(403)
                xhr.setRequestHeader(header, token)
            },
            success: function (res) {
                alert("회원 정보가 수정되었습니다")

                // 화면 업데이트
                // $("#userprofile-img").attr("src", $("#userprofile-img").attr("src"));
                $("#username-span").text($("#username-input").val());
                // 나이 : "세" 붙이기
                const newAge = $("#userage-input").val();
                $("#userage-span").text(newAge ? `${newAge}세` : "예: 25세");
                // 성별 : 선택 안할 시 "선택 안함" 기본!
                const newGender = $("#usergender-select").val();
                $("#usergender-span").text(newGender ? newGender : "선택 안함");
                $("#useraddress-span").text($("#useraddress-input").val());

                if (res && res.profileImgUrl) {
                    const url = res.profileImgUrl + "?v=" + Date.now();
                    $("#profileImageView").attr("src", url);
                    $("#profileImageEdit").attr("src", url);
                }


                cancelBtn()
            }, 
            error: function (xhr, status, error) {
                // xhr : AJAX 요청에 대한 전체 HTTP 응답 객체
                // status : AJAX 요청 상태를 문자열로 나타낸 것
                if (xhr.status === 404) {
                    alert("잘못된 요청입니다");
                } else {
                    alert("서버 내부 오류입니다.");
                }
            }
        })
    }
    // 사진 변경 버튼 -> 파일 선택창 열기
    document.addEventListener("DOMContentLoaded", () => {
        const btnChangePhoto = document.getElementById("btnChangePhoto");
        const profileFile = document.getElementById("profileImg");
        const profileImg = document.getElementById("profileImageEdit");

        btnChangePhoto?.addEventListener("click", (e) => {
            e.preventDefault();
            profileFile?.click();
        });

        profileFile?.addEventListener("change", function () {
            const file = this.files && this.files[0];
            if (!file) return;

            if (!file.type || !file.type.startsWith("image/")) {
            alert("이미지 파일만 선택할 수 있습니다.");
            this.value = "";
            return;
            }

            // 미리보기
            const reader = new FileReader();
            reader.onload = (ev) => {
            profileImg.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        });
    });


    // ------------------------------------------------------------------
    // 회원 탈퇴 - 모달 열기 (회원탈퇴 버튼)
    function openModal() {
        // $("#delete-modal").show()
        $("#delete-modal").css("display", "flex")
    }
    // 회원 탈퇴 - 모달 닫기 
    function closeModal() {
        $("#delete-modal").hide()
    }
    // 회원 탈퇴 (탈퇴하기 버튼)
    function userDelete() {

        // CSRF 토큰 문제 (403)
        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: `/users/mypage/modal`,
            method: 'DELETE',
            beforeSend: function (xhr) {    // CSRF 토큰 문제(403)
                xhr.setRequestHeader(header, token)
            },
            success: function (result, status, xhr) {
                alert("탈퇴가 완료되었습니다")
                window.location.href = "/";     // 탈퇴 후 메인 이동
            }, 
            error: function (xhr, status, error) {
                // xhr : AJAX 요청에 대한 전체 HTTP 응답 객체
                // status : AJAX 요청 상태를 문자열로 나타낸 것
                if (xhr.status === 404) {
                    alert("잘못된 요청입니다");
                } else {
                    alert("서버 내부 오류입니다.")
                }
            }
        })
    }
    </script>
    </th:block>
</body>
</html>