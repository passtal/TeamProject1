<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/main_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ë‹¤ë¦¬ ê²Œì„ - ë‘ë£¨ë‘ë£¹</title>
    <link rel="stylesheet" th:href="@{/css/ladder.css}">
</head>
<body>
    <main layout:fragment="content" class="ladder-page">
        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <div class="back-button-container">
            <a href="/game/list" class="back-button">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.5 15L7.5 10L12.5 5" stroke="#364153" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>ê²Œì„ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
            </a>
        </div>

        <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
        <div class="ladder-container">
            <!-- ì‚¬ë‹¤ë¦¬ ì„¤ì • -->
            <div class="ladder-settings">
                <h2>ì‚¬ë‹¤ë¦¬ ì„¤ì •</h2>
                
                <div class="settings-content">
                    <!-- ì°¸ê°€ì ìˆ˜ ì¡°ì ˆ -->
                    <div class="setting-section">
                        <label class="setting-label">ì°¸ê°€ì ìˆ˜: <span id="participantCount">4</span>ëª…</label>
                        <div class="slider-container">
                            <button class="slider-button" id="decreaseBtn">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 10H15" stroke="#364153" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                            <div class="slider-track">
                                <div class="slider-fill" id="sliderFill"></div>
                            </div>
                            <button class="slider-button" id="increaseBtn">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 5V15M5 10H15" stroke="#364153" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- ì°¸ê°€ì ì´ë¦„ ì…ë ¥ -->
                    <div class="setting-section">
                        <label class="setting-label">ì°¸ê°€ì ì´ë¦„</label>
                        <div class="input-grid" id="participantInputs">
                            <input type="text" class="text-input" placeholder="ì°¸ê°€ì1" value="ì°¸ê°€ì1">
                            <input type="text" class="text-input" placeholder="ì°¸ê°€ì2" value="ì°¸ê°€ì2">
                            <input type="text" class="text-input" placeholder="ì°¸ê°€ì3" value="ì°¸ê°€ì3">
                            <input type="text" class="text-input" placeholder="ì°¸ê°€ì4" value="ì°¸ê°€ì4">
                        </div>
                    </div>

                    <!-- ê²°ê³¼/ìƒí’ˆ ì…ë ¥ -->
                    <div class="setting-section">
                        <label class="setting-label">ê²°ê³¼/ìƒí’ˆ</label>
                        <div class="input-grid" id="prizeInputs">
                            <input type="text" class="text-input" placeholder="1ë“±" value="1ë“±">
                            <input type="text" class="text-input" placeholder="2ë“±" value="2ë“±">
                            <input type="text" class="text-input" placeholder="3ë“±" value="3ë“±">
                            <input type="text" class="text-input" placeholder="4ë“±" value="4ë“±">
                        </div>
                    </div>

                    <!-- ì‚¬ë‹¤ë¦¬ ìƒì„± ë²„íŠ¼ -->
                    <button class="generate-button" id="generateBtn">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.5 10.833C17.5 14.975 14.142 18.333 10 18.333C5.858 18.333 2.5 14.975 2.5 10.833C2.5 6.692 5.858 3.333 10 3.333C11.392 3.333 12.708 3.7 13.842 4.333M17.5 3.333L10 10.833L7.917 8.75" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        ì‚¬ë‹¤ë¦¬ ìƒì„±
                    </button>
                </div>
            </div>

            <!-- ì‚¬ë‹¤ë¦¬ íƒ€ê¸° (ìˆ¨ê¹€ ì²˜ë¦¬) -->
            <div class="ladder-game" id="ladderGame" style="display: none;">
                <h2>ì‚¬ë‹¤ë¦¬ íƒ€ê¸°</h2>
                
                <!-- ì°¸ê°€ì ë²„íŠ¼ë“¤ -->
                <div class="participant-buttons" id="participantButtons">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>

                <!-- ëª¨ë“  ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ -->
                <button class="show-all-button" id="showAllBtn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 5V15M5 10L10 15L15 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    ëª¨ë“  ê²°ê³¼ ë³´ê¸°
                </button>

                <!-- ì‚¬ë‹¤ë¦¬ ìº”ë²„ìŠ¤ -->
                <div class="ladder-canvas-wrapper">
                    <canvas id="ladderCanvas" class="ladder-canvas hidden"></canvas>
                    <div class="ladder-overlay" id="ladderOverlay">
                        <div class="ladder-overlay-text">ğŸ² ì‚¬ë‹¤ë¦¬ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                        <div class="ladder-overlay-subtext">ì°¸ê°€ì ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</div>
                    </div>
                </div>

                <!-- ê²°ê³¼/ìƒí’ˆ í‘œì‹œ -->
                <div class="prize-display" id="prizeDisplay">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>

                <!-- ê²Œì„ ê²°ê³¼ ë©”ì‹œì§€ (ìˆ¨ê¹€ ì²˜ë¦¬) -->
                <div class="result-message" id="resultMessage" style="display: none;">
                    <div id="resultList"></div>
                    <button class="retry-button" id="retryBtn" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.5 10C17.5 14.142 14.142 17.5 10 17.5C5.858 17.5 2.5 14.142 2.5 10C2.5 5.858 5.858 2.5 10 2.5C11.683 2.5 13.25 3.025 14.542 3.917M17.5 2.5V6.667H13.333" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        ë‹¤ì‹œí•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- ê²Œì„ ë°©ë²• -->
            <div class="game-instructions">
                <h3>ê²Œì„ ë°©ë²•</h3>
                <ul class="instruction-list">
                    <li><span class="bullet">â€¢</span><span>ì°¸ê°€ì ìˆ˜ë¥¼ ì„ íƒí•˜ê³  ì°¸ê°€ì ì´ë¦„ê³¼ ê²°ê³¼/ìƒí’ˆì„ ì…ë ¥í•˜ì„¸ìš”.</span></li>
                    <li><span class="bullet">â€¢</span><span>"ì‚¬ë‹¤ë¦¬ ìƒì„±" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¬´ì‘ìœ„ ì‚¬ë‹¤ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</span></li>
                    <li><span class="bullet">â€¢</span><span>ì°¸ê°€ì ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‚¬ë‹¤ë¦¬ë¥¼ íƒ€ê³  ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</span></li>
                    <li><span class="bullet">â€¢</span><span>ë¹¨ê°„ ì„ ì´ ê²½ë¡œë¥¼ í‘œì‹œí•˜ê³  ìµœì¢… ê²°ê³¼ë¥¼ ì•Œë ¤ì¤ë‹ˆë‹¤.</span></li>
                </ul>
            </div>
        </div>
    </main>
    
    <script th:src="@{/js/ladder.js}"></script>
    <script>

// ì‚¬ë‹¤ë¦¬ ê²Œì„ JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const participantCountEl = document.getElementById('participantCount');
    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');
    const sliderFill = document.getElementById('sliderFill');
    const participantInputs = document.getElementById('participantInputs');
    const prizeInputs = document.getElementById('prizeInputs');
    const generateBtn = document.getElementById('generateBtn');

    let participantCount = 4;
    const minParticipants = 2;
    const maxParticipants = 8;

    // ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
    function updateSlider() {
        const percentage = ((participantCount - minParticipants) / (maxParticipants - minParticipants)) * 100;
        sliderFill.style.width = percentage + '%';
        participantCountEl.textContent = participantCount;
    }

    // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    function updateInputs() {
        // ì°¸ê°€ì ì…ë ¥ í•„ë“œ
        participantInputs.innerHTML = '';
        for (let i = 1; i <= participantCount; i++) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'text-input';
            input.placeholder = 'ì°¸ê°€ì' + i;
            input.value = 'ì°¸ê°€ì' + i;
            participantInputs.appendChild(input);
        }

        // ê²°ê³¼/ìƒí’ˆ ì…ë ¥ í•„ë“œ
        prizeInputs.innerHTML = '';
        for (let i = 1; i <= participantCount; i++) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'text-input';
            input.placeholder = i + 'ë“±';
            input.value = i + 'ë“±';
            prizeInputs.appendChild(input);
        }
    }

    // ì°¸ê°€ì ìˆ˜ ê°ì†Œ
    decreaseBtn.addEventListener('click', function() {
        if (participantCount > minParticipants) {
            participantCount--;
            updateSlider();
            updateInputs();
        }
    });

    // ì°¸ê°€ì ìˆ˜ ì¦ê°€
    increaseBtn.addEventListener('click', function() {
        if (participantCount < maxParticipants) {
            participantCount++;
            updateSlider();
            updateInputs();
        }
    });

    // ì‚¬ë‹¤ë¦¬ ìƒì„± ë²„íŠ¼
    generateBtn.addEventListener('click', function() {
        // ì°¸ê°€ì ì´ë¦„ ìˆ˜ì§‘
        const participants = [];
        const participantInputFields = participantInputs.querySelectorAll('input');
        participantInputFields.forEach(input => {
            const name = input.value.trim();
            if (name) {
                participants.push(name);
            }
        });

        // ê²°ê³¼/ìƒí’ˆ ìˆ˜ì§‘
        const prizes = [];
        const prizeInputFields = prizeInputs.querySelectorAll('input');
        prizeInputFields.forEach(input => {
            const prize = input.value.trim();
            if (prize) {
                prizes.push(prize);
            }
        });

        // ìœ íš¨ì„± ê²€ì‚¬
        if (participants.length !== participantCount) {
            alert('ëª¨ë“  ì°¸ê°€ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (prizes.length !== participantCount) {
            alert('ëª¨ë“  ê²°ê³¼/ìƒí’ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ì‚¬ë‹¤ë¦¬ ê²Œì„ ìƒì„± ë° í‘œì‹œ
        generateLadder(participants, prizes);
    });

    // ì‚¬ë‹¤ë¦¬ ìƒì„± ë° í‘œì‹œ í•¨ìˆ˜
    function generateLadder(participants, prizes) {
        const ladderGame = document.getElementById('ladderGame');
        const participantButtons = document.getElementById('participantButtons');
        const prizeDisplay = document.getElementById('prizeDisplay');
        const canvas = document.getElementById('ladderCanvas');
        const ctx = canvas.getContext('2d');
        const resultMessage = document.getElementById('resultMessage');
        const resultList = document.getElementById('resultList');

        // ì´ì „ ê²°ê³¼ ì´ˆê¸°í™”
        clickedParticipants.clear();
        resultList.innerHTML = '';
        resultMessage.style.display = 'none';

        // ì‚¬ë‹¤ë¦¬ ê²Œì„ ì„¹ì…˜ ë¨¼ì € í‘œì‹œ
        ladderGame.style.display = 'block';

        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (í‘œì‹œ í›„ì— ì„¤ì •í•´ì•¼ offsetWidthê°€ ì •ìƒì ìœ¼ë¡œ ê³„ì‚°ë¨)
        setTimeout(() => {
            canvas.width = canvas.offsetWidth;
            canvas.height = 565;

            // ì‚¬ë‹¤ë¦¬ ë°ì´í„° ìƒì„±
            const ladderData = createLadderData(participants.length);

            // ì°¸ê°€ì ë²„íŠ¼ ìƒì„±
            participantButtons.innerHTML = '';
            participants.forEach((name, index) => {
                const btn = document.createElement('button');
                btn.className = 'participant-btn';
                btn.textContent = name;
                btn.dataset.index = index;
                btn.addEventListener('click', () => animateLadder(index, ladderData, prizes, participants));
                participantButtons.appendChild(btn);
            });

            // ê²°ê³¼/ìƒí’ˆ í‘œì‹œ
            prizeDisplay.innerHTML = '';
            prizes.forEach(prize => {
                const box = document.createElement('div');
                box.className = 'prize-box';
                box.textContent = prize;
                prizeDisplay.appendChild(box);
            });

            // ì‚¬ë‹¤ë¦¬ ê·¸ë¦¬ê¸°
            drawLadder(ctx, canvas.width, canvas.height, participants.length, ladderData);

            // ì‚¬ë‹¤ë¦¬ ê²Œì„ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            ladderGame.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // ëª¨ë“  ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
            const showAllBtn = document.getElementById('showAllBtn');
            if (showAllBtn) {
                const newShowAllBtn = showAllBtn.cloneNode(true);
                showAllBtn.parentNode.replaceChild(newShowAllBtn, showAllBtn);
                newShowAllBtn.addEventListener('click', () => showAllResults(ladderData, prizes, participants));
            }
        }, 10);
    }

    // ì‚¬ë‹¤ë¦¬ ì‹œë®¬ë ˆì´ì…˜ (íŠ¹ì • ì‹œì‘ì ì—ì„œ ë„ì°©ì  ê³„ì‚°)
    function simulateLadderPath(startIndex, ladderData, participantCount) {
        let currentCol = startIndex;
        
        ladderData.forEach((row) => {
            // ì™¼ìª½ì— ê°€ë¡œì„ ì´ ìˆëŠ”ì§€ í™•ì¸
            if (currentCol > 0 && row[currentCol - 1]) {
                currentCol--;
            }
            // ì˜¤ë¥¸ìª½ì— ê°€ë¡œì„ ì´ ìˆëŠ”ì§€ í™•ì¸
            else if (currentCol < participantCount - 1 && row[currentCol]) {
                currentCol++;
            }
        });
        
        return currentCol;
    }

    // ì‚¬ë‹¤ë¦¬ ë°ì´í„° ìƒì„± (ìˆœì—´ ê¸°ë°˜ìœ¼ë¡œ ì¤‘ë³µ ì—†ëŠ” ê²°ê³¼ ë³´ì¥)
    function createLadderData(participantCount) {
        let attempts = 0;
        const maxAttempts = 100;
        
        while (attempts < maxAttempts) {
            attempts++;
            
            const rows = 15;
            const ladderData = [];
            
            for (let rowIndex = 0; rowIndex < rows; rowIndex++) {
                const row = [];
                const isLastRows = rowIndex >= rows - 2; // ë§ˆì§€ë§‰ 2ì¤„
                let prevHasLine = false;
                
                for (let colIndex = 0; colIndex < participantCount - 1; colIndex++) {
                    if (isLastRows) {
                        row.push(false);
                    } else if (prevHasLine) {
                        // ì´ì „ì— ê°€ë¡œì„ ì´ ìˆìœ¼ë©´ ì´ë²ˆì—” false
                        row.push(false);
                        prevHasLine = false;
                    } else {
                        // 60% í™•ë¥ ë¡œ ê°€ë¡œì„  ìƒì„±
                        const hasLine = Math.random() > 0.4;
                        row.push(hasLine);
                        prevHasLine = hasLine;
                    }
                }
                ladderData.push(row);
            }
            
            // ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ê²°ê³¼ ê²€ì¦
            const results = [];
            for (let i = 0; i < participantCount; i++) {
                const result = simulateLadderPath(i, ladderData, participantCount);
                results.push(result);
            }
            
            // ì¤‘ë³µ ê²€ì‚¬
            const uniqueResults = new Set(results);
            if (uniqueResults.size === participantCount) {
                console.log(`ì‚¬ë‹¤ë¦¬ ìƒì„± ì„±ê³µ (ì‹œë„ ${attempts}íšŒ)`);
                return ladderData;
            }
        }
        
        console.error('ì‚¬ë‹¤ë¦¬ ìƒì„± ì‹¤íŒ¨, ê¸°ë³¸ ì‚¬ë‹¤ë¦¬ ë°˜í™˜');
        // ìµœì•…ì˜ ê²½ìš° ë¹ˆ ì‚¬ë‹¤ë¦¬ ë°˜í™˜ (ëª¨ë“  ì°¸ê°€ìê°€ ì§ì§„)
        return Array(15).fill(null).map(() => Array(participantCount - 1).fill(false));
    }

    // ì‚¬ë‹¤ë¦¬ ê·¸ë¦¬ê¸°
    function drawLadder(ctx, width, height, participantCount, ladderData) {
        ctx.clearRect(0, 0, width, height);
        ctx.strokeStyle = '#00a651';
        ctx.lineWidth = 2;

        const padding = 80;
        const usableWidth = width - padding * 2;
        const columnSpacing = usableWidth / (participantCount - 1);
        const rowHeight = height / (ladderData.length + 1);

        // ì„¸ë¡œì„  ê·¸ë¦¬ê¸°
        for (let i = 0; i < participantCount; i++) {
            const x = padding + i * columnSpacing;
            ctx.beginPath();
            ctx.moveTo(x, 20);
            ctx.lineTo(x, height - 20);
            ctx.stroke();
            
            // ì‹œì‘ì  ì› ê·¸ë¦¬ê¸°
            ctx.beginPath();
            ctx.arc(x, 20, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#00a651';
            ctx.fill();
            
            // ëì  ì› ê·¸ë¦¬ê¸°
            ctx.beginPath();
            ctx.arc(x, height - 20, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#00a651';
            ctx.fill();
        }

        // ê°€ë¡œì„  ê·¸ë¦¬ê¸°
        ladderData.forEach((row, rowIndex) => {
            const y = 20 + (rowIndex + 1) * rowHeight;
            row.forEach((hasLine, colIndex) => {
                if (hasLine) {
                    const x1 = padding + colIndex * columnSpacing;
                    const x2 = padding + (colIndex + 1) * columnSpacing;
                    ctx.beginPath();
                    ctx.moveTo(x1, y);
                    ctx.lineTo(x2, y);
                    ctx.stroke();
                }
            });
        });
    }

    // ì‚¬ë‹¤ë¦¬ íƒ€ê¸° ì• ë‹ˆë©”ì´ì…˜ (ì°¸ê°€ì ë°°ì—´ êµí™˜ ë°©ì‹)
    const participantColors = ['#ff0000', '#0066ff', '#ff6600', '#9900ff', '#00cc66', '#ff00cc', '#ffcc00', '#00ccff'];
    const clickedParticipants = new Set(); // ì´ë¯¸ í´ë¦­í•œ ì°¸ê°€ì ì¶”ì 
    let isAutoPlaying = false; // ìë™ ì¬ìƒ ì¤‘ì¸ì§€ ì²´í¬

    function animateLadder(startIndex, ladderData, prizes, participantNames, isAuto = false) {
        const canvas = document.getElementById('ladderCanvas');
        const ctx = canvas.getContext('2d');
        const participantCount = prizes.length;
        const participantButtons = document.querySelectorAll('.participant-btn');
        const resultMessage = document.getElementById('resultMessage');
        const resultList = document.getElementById('resultList');
        const ladderOverlay = document.getElementById('ladderOverlay');
        
        // ì²« ë²ˆì§¸ í´ë¦­ ì‹œ ì‚¬ë‹¤ë¦¬ ë³´ì´ê¸°
        if (clickedParticipants.size === 0 && !isAuto) {
            canvas.classList.remove('hidden');
            if (ladderOverlay) {
                ladderOverlay.classList.add('hidden');
            }
        }
        
        // ì´ë¯¸ í´ë¦­í•œ ì°¸ê°€ìë©´ ë¬´ì‹œ
        if (clickedParticipants.has(startIndex)) {
            return;
        }
        
        // í´ë¦­í•œ ì°¸ê°€ì ì¶”ê°€
        clickedParticipants.add(startIndex);
        
        // í´ë¦­í•œ ë²„íŠ¼ë§Œ ë¹„í™œì„±í™”
        participantButtons[startIndex].disabled = true;
        participantButtons[startIndex].classList.add('clicked');
        
        const padding = 80;
        const usableWidth = canvas.width - padding * 2;
        const columnSpacing = usableWidth / (participantCount - 1);
        const rowHeight = canvas.height / (ladderData.length + 1);

        // ê²½ë¡œ ê³„ì‚°
        let currentCol = startIndex;
        const path = [{x: padding + currentCol * columnSpacing, y: 20}];

        ladderData.forEach((row, rowIndex) => {
            const y = 20 + (rowIndex + 1) * rowHeight;
            
            // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì™¼ìª½ì— ê°€ë¡œì„ ì´ ìˆëŠ”ì§€ í™•ì¸
            if (currentCol > 0 && row[currentCol - 1]) {
                path.push({x: padding + currentCol * columnSpacing, y: y});
                currentCol--;
                path.push({x: padding + currentCol * columnSpacing, y: y});
            }
            // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì˜¤ë¥¸ìª½ì— ê°€ë¡œì„ ì´ ìˆëŠ”ì§€ í™•ì¸
            else if (currentCol < participantCount - 1 && row[currentCol]) {
                path.push({x: padding + currentCol * columnSpacing, y: y});
                currentCol++;
                path.push({x: padding + currentCol * columnSpacing, y: y});
            }
            else {
                path.push({x: padding + currentCol * columnSpacing, y: y});
            }
        });

        path.push({x: padding + currentCol * columnSpacing, y: canvas.height - 20});

        // ì• ë‹ˆë©”ì´ì…˜
        let step = 0;
        const animationSpeed = 15;
        const pathColor = participantColors[startIndex % participantColors.length];

        const animate = setInterval(() => {
            if (step < path.length - 1) {
                ctx.strokeStyle = pathColor;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(path[step].x, path[step].y);
                ctx.lineTo(path[step + 1].x, path[step + 1].y);
                ctx.stroke();
                step++;
            } else {
                clearInterval(animate);
                
                // ê²°ê³¼
                const prizeBoxes = document.querySelectorAll('.prize-box');
                if (!prizeBoxes[currentCol].classList.contains('winner')) {
                    prizeBoxes[currentCol].classList.add('winner');
                }
                
                // ì°¸ê°€ì ì´ë¦„
                const participantName = participantNames[startIndex];
                
                // ê²°ê³¼ ë©”ì‹œì§€ ì¶”ê°€
                const resultItem = document.createElement('p');
                resultItem.className = 'result-item';
                resultItem.textContent = `ğŸ‰ ${participantName}ë‹˜ì˜ ê²°ê³¼ëŠ” "${prizes[currentCol]}"ì…ë‹ˆë‹¤!`;
                resultList.appendChild(resultItem);
                
                resultMessage.style.display = 'block';
                
                // ëª¨ë“  ì°¸ê°€ìê°€ ê²°ê³¼ë¥¼ í™•ì¸í–ˆëŠ”ì§€ ì²´í¬
                if (clickedParticipants.size === participantCount) {
                    setTimeout(() => {
                        const finalMessage = document.createElement('p');
                        finalMessage.className = 'result-item';
                        finalMessage.style.marginTop = '16px';
                        finalMessage.style.fontSize = '18px';
                        finalMessage.textContent = 'âœ… ëª¨ë“  ì°¸ê°€ìì˜ ê²°ê³¼ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!';
                        resultList.appendChild(finalMessage);
                        
                        // ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼ í‘œì‹œ
                        const retryBtn = document.getElementById('retryBtn');
                        retryBtn.style.display = 'flex';
                        
                        // ìë™ ì¬ìƒ ì¢…ë£Œ
                        isAutoPlaying = false;
                        
                        // ëª¨ë“  ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ ë¹„í™œì„±í™”
                        const showAllBtn = document.getElementById('showAllBtn');
                        if (showAllBtn) {
                            showAllBtn.disabled = true;
                        }
                    }, 300);
                }
            }
        }, animationSpeed);
    }

    // ëª¨ë“  ê²°ê³¼ ë³´ê¸° ê¸°ëŠ¥
    function showAllResults(ladderData, prizes, participantNames) {
        if (isAutoPlaying) return;
        
        isAutoPlaying = true;
        const participantCount = participantNames.length;
        const showAllBtn = document.getElementById('showAllBtn');
        const participantButtons = document.querySelectorAll('.participant-btn');
        const canvas = document.getElementById('ladderCanvas');
        const ladderOverlay = document.getElementById('ladderOverlay');
        
        // ì‚¬ë‹¤ë¦¬ ë³´ì´ê¸°
        canvas.classList.remove('hidden');
        if (ladderOverlay) {
            ladderOverlay.classList.add('hidden');
        }
        
        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
        showAllBtn.disabled = true;
        participantButtons.forEach(btn => btn.disabled = true);
        
        let currentIndex = 0;
        
        function playNext() {
            if (currentIndex < participantCount) {
                if (clickedParticipants.has(currentIndex)) {
                    currentIndex++;
                    playNext();
                    return;
                }
                
                animateLadder(currentIndex, ladderData, prizes, participantNames, true);
                
                // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ + ì¶”ê°€ ëŒ€ê¸°
                setTimeout(() => {
                    currentIndex++;
                    playNext();
                }, 1500);
            }
        }
        
        playNext();
    }

    // ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'retryBtn') {
            const ladderGame = document.getElementById('ladderGame');
            const resultMessage = document.getElementById('resultMessage');
            const resultList = document.getElementById('resultList');
            const retryBtn = document.getElementById('retryBtn');
            const canvas = document.getElementById('ladderCanvas');
            const ctx = canvas.getContext('2d');
            const participantButtons = document.querySelectorAll('.participant-btn');
            const prizeBoxes = document.querySelectorAll('.prize-box');
            const ladderOverlay = document.getElementById('ladderOverlay');
            
            // ì´ˆê¸°í™”
            clickedParticipants.clear();
            resultList.innerHTML = '';
            retryBtn.style.display = 'none';
            resultMessage.style.display = 'none';
            isAutoPlaying = false;
            
            // ì‚¬ë‹¤ë¦¬ ê°€ë¦¬ê¸°
            canvas.classList.add('hidden');
            if (ladderOverlay) {
                ladderOverlay.classList.remove('hidden');
            }
            
            // ì°¸ê°€ì ë²„íŠ¼ ì´ˆê¸°í™”
            participantButtons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('clicked', 'inactive');
            });
            
            // ê²°ê³¼ ë°•ìŠ¤ ì´ˆê¸°í™”
            prizeBoxes.forEach(box => {
                box.classList.remove('winner');
            });
            
            // ëª¨ë“  ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ ì´ˆê¸°í™”
            const showAllBtn = document.getElementById('showAllBtn');
            if (showAllBtn) {
                showAllBtn.disabled = false;
            }
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ë° ìƒˆ ì‚¬ë‹¤ë¦¬ ìƒì„±
            const participantCount = participantButtons.length;
            const ladderData = createLadderData(participantCount);
            drawLadder(ctx, canvas.width, canvas.height, participantCount, ladderData);
            
            // ì°¸ê°€ì ì´ë¦„ê³¼ ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const participants = Array.from(participantButtons).map(btn => btn.textContent);
            const prizes = Array.from(prizeBoxes).map(box => box.textContent);
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
            participantButtons.forEach((btn, index) => {
                const oldBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(oldBtn, btn);
                oldBtn.addEventListener('click', () => animateLadder(index, ladderData, prizes, participants));
            });
            
            // ì‚¬ë‹¤ë¦¬ ê²Œì„ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            ladderGame.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });

    // ì´ˆê¸° ì„¤ì •
    updateSlider();
});

    </script>
</body>
</html>