<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¹ì²¨ì ì¶”ì²¨ - ë‘ë£¨ë‘ë£¹</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/game/random.css}">
    </th:block>
</head>

<body>
    <main layout:fragment="content" class="random-page">
        <div class="random-container">
            <!-- Back Button -->
            <div class="back-button">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M12.5 15L7.5 10L12.5 5" stroke="#364153" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <a href="/game/list">ê²Œì„ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            </div>

            <!-- Main Container -->
            <div class="main-container">
                <!-- Draw Section -->
                <div class="draw-section">
                    <h2>ğŸ ë‹¹ì²¨ì ì¶”ì²¨ ğŸ</h2>
                    <div class="result-display" id="resultDisplay">
                        <p class="result-message" id="resultMessage">ì¶”ì²¨ì„ ì‹œì‘í•´ì£¼ì„¸ìš”</p>
                        <p class="participant-count" id="participantCount">ì´ 5ëª… ì°¸ê°€ ì¤‘</p>
                        <div class="winner-announcement" id="winnerAnnouncement" style="display: none;">
                            <p class="announcement-title">ğŸ‰ ë‹¹ì²¨ì ë°œí‘œ ğŸ‰</p>
                            <div class="winner-box" id="winnerBox">
                                ì°¸ê°€ì1
                            </div>
                        </div>
                    </div>
                    <div class="button-container">
                        <button class="draw-button" id="drawButton">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2V6M12 18V22M22 12H18M6 12H2" stroke="#9810fa" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            ì¶”ì²¨ ì‹œì‘
                        </button>
                        <button class="retry-button" id="retryButton" style="display: none;">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M2 10C2 5.58172 5.58172 2 10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18" stroke="#364153" stroke-width="2" stroke-linecap="round"/>
                                <path d="M6 18L10 18L10 14" stroke="#364153" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            ë‹¤ì‹œ ì¶”ì²¨
                        </button>
                    </div>
                </div>

                <!-- Bottom Grid -->
                <div class="bottom-grid">
                    <!-- Participants Section -->
                    <div class="participants-section">
                        <div class="participants-header">
                            <h3>ì°¸ê°€ì ëª©ë¡</h3>
                            <div class="button-group">
                                <button class="add-button" id="addParticipantButton">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M8 3V13M3 8H13" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    ì¶”ê°€
                                </button>
                                <button class="clear-button" id="clearAllButton">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13 3L3 13M3 3L13 13" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    ì „ì²´ ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        <div class="participants-list" id="participantsList">
                            <!-- Participants will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div class="settings-section">
                        <h3>ì¶”ì²¨ ì„¤ì •</h3>
                        <div class="settings-content">
                            <div class="slider-container">
                                <label id="winnerCountLabel">ë‹¹ì²¨ì ìˆ˜: 1ëª…</label>
                                <input type="range" id="winnerCountSlider" min="1" max="5" value="1" class="slider">
                                <div class="slider-labels">
                                    <span>1ëª…</span>
                                    <span>5ëª…</span>
                                </div>
                            </div>
                            <div class="info-box">
                                <p><strong id="totalParticipants">5ëª…</strong> ì¤‘ <strong id="selectedWinners">1ëª…</strong>ì„ ì¶”ì²¨í•©ë‹ˆë‹¤</p>
                                <p class="probability" id="probability">ë‹¹ì²¨ í™•ë¥ : 20.0%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instructions Section -->
                <div class="instructions-section">
                    <h3>ê²Œì„ ë°©ë²•</h3>
                    <ul>
                        <li>ì°¸ê°€ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</li>
                        <li>ë‹¹ì²¨ì ìˆ˜ë¥¼ ì„¤ì •í•˜ê³  "ì¶”ì²¨ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</li>
                        <li>ì¶”ì²¨ ì• ë‹ˆë©”ì´ì…˜ í›„ ë‹¹ì²¨ìê°€ ë°œí‘œë©ë‹ˆë‹¤.</li>
                        <li>ê³µì •í•œ ë¬´ì‘ìœ„ ì¶”ì²¨ìœ¼ë¡œ ëª¨ë“  ì°¸ê°€ìì—ê²Œ ë™ë“±í•œ ê¸°íšŒê°€ ì£¼ì–´ì§‘ë‹ˆë‹¤.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- <script th:src="@{/js/random.js}"></script> -->
    <script>
    // Random JavaScript
    let participants = [
        'ì°¸ê°€ì1',
        'ì°¸ê°€ì2',
        'ì°¸ê°€ì3',
        'ì°¸ê°€ì4',
        'ì°¸ê°€ì5'
    ];

    let isDrawing = false;

    // DOM elements
    const drawButton = document.getElementById('drawButton');
    const retryButton = document.getElementById('retryButton');
    const addParticipantButton = document.getElementById('addParticipantButton');
    const clearAllButton = document.getElementById('clearAllButton');
    const participantsList = document.getElementById('participantsList');
    const winnerCountSlider = document.getElementById('winnerCountSlider');
    const winnerCountLabel = document.getElementById('winnerCountLabel');
    const resultMessage = document.getElementById('resultMessage');
    const participantCount = document.getElementById('participantCount');
    const totalParticipants = document.getElementById('totalParticipants');
    const selectedWinners = document.getElementById('selectedWinners');
    const probability = document.getElementById('probability');
    const resultDisplay = document.getElementById('resultDisplay');
    const winnerAnnouncement = document.getElementById('winnerAnnouncement');
    const winnerBox = document.getElementById('winnerBox');

    // Initialize
    function init() {
        renderParticipants();
        updateSliderMax();
        updateProbability();
        
        drawButton.addEventListener('click', startDraw);
        retryButton.addEventListener('click', retryDraw);
        addParticipantButton.addEventListener('click', addParticipant);
        clearAllButton.addEventListener('click', clearAll);
        winnerCountSlider.addEventListener('input', updateWinnerCount);
    }

    // Render participants list
    function renderParticipants() {
        participantsList.innerHTML = '';
        
        participants.forEach((name, index) => {
            const row = document.createElement('div');
            row.className = 'participant-row';
            
            const number = document.createElement('div');
            number.className = 'participant-number';
            number.textContent = index + 1;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'participant-input';
            input.value = name;
            input.placeholder = `ì°¸ê°€ì${index + 1}`;
            input.addEventListener('input', (e) => {
                participants[index] = e.target.value;
                updateParticipantCount();
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-participant-button';
            deleteBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M15 5L5 15M5 5L15 15" stroke="#364153" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;
            deleteBtn.addEventListener('click', () => deleteParticipant(index));
            
            row.appendChild(number);
            row.appendChild(input);
            row.appendChild(deleteBtn);
            participantsList.appendChild(row);
        });
        
        updateParticipantCount();
    }

    // Update participant count display
    function updateParticipantCount() {
        const count = participants.filter(p => p.trim() !== '').length;
        participantCount.textContent = `ì´ ${count}ëª… ì°¸ê°€ ì¤‘`;
        totalParticipants.textContent = `${count}ëª…`;
        updateSliderMax();
        updateProbability();
    }

    // Update slider max value
    function updateSliderMax() {
        const count = participants.filter(p => p.trim() !== '').length;
        winnerCountSlider.max = Math.max(1, count);
        if (parseInt(winnerCountSlider.value) > count) {
            winnerCountSlider.value = count;
            updateWinnerCount();
        }
    }

    // Update winner count display
    function updateWinnerCount() {
        const value = winnerCountSlider.value;
        winnerCountLabel.textContent = `ë‹¹ì²¨ì ìˆ˜: ${value}ëª…`;
        selectedWinners.textContent = `${value}ëª…`;
        updateProbability();
    }

    // Update probability display
    function updateProbability() {
        const count = participants.filter(p => p.trim() !== '').length;
        const winners = parseInt(winnerCountSlider.value);
        const prob = count > 0 ? (winners / count * 100).toFixed(1) : 0;
        probability.textContent = `ë‹¹ì²¨ í™•ë¥ : ${prob}%`;
    }

    // Add new participant
    function addParticipant() {
        const newIndex = participants.length + 1;
        participants.push(`ì°¸ê°€ì${newIndex}`);
        renderParticipants();
    }

    // Delete participant
    function deleteParticipant(index) {
        if (participants.length <= 1) {
            alert('ìµœì†Œ 1ëª…ì˜ ì°¸ê°€ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        
        participants.splice(index, 1);
        renderParticipants();
    }

    // Clear all participants
    function clearAll() {
        if (confirm('ëª¨ë“  ì°¸ê°€ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            participants = ['ì°¸ê°€ì1'];
            renderParticipants();
        }
    }

    // Start draw animation
    async function startDraw() {
        if (isDrawing) return;
        
        const validParticipants = participants.filter(p => p.trim() !== '');
        const winnerCount = parseInt(winnerCountSlider.value);
        
        if (validParticipants.length === 0) {
            alert('ì°¸ê°€ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (winnerCount > validParticipants.length) {
            alert('ë‹¹ì²¨ì ìˆ˜ëŠ” ì°¸ê°€ì ìˆ˜ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        isDrawing = true;
        drawButton.disabled = true;
        
        // Hide winner announcement
        winnerAnnouncement.style.display = 'none';
        resultDisplay.classList.remove('has-winner');
        resultMessage.style.display = 'block';
        participantCount.style.display = 'block';
        
        // Remove winner class from all inputs
        document.querySelectorAll('.participant-input').forEach(input => {
            input.classList.remove('winner');
        });
        
        // Shuffle animation with deceleration effect (3 seconds total)
        resultMessage.textContent = 'ì¶”ì²¨ ì¤‘...';
        const totalIterations = 25; // Total number of iterations
        const minInterval = 40; // Starting interval (fast)
        const maxInterval = 200; // Ending interval (slow)
        
        for (let i = 0; i < totalIterations; i++) {
            const randomIndex = Math.floor(Math.random() * validParticipants.length);
            resultMessage.textContent = validParticipants[randomIndex];
            resultMessage.classList.add('shuffling');
            
            // Calculate deceleration - exponential slowdown
            const progress = i / totalIterations;
            const easedProgress = Math.pow(progress, 2); // Quadratic easing
            const currentInterval = minInterval + (maxInterval - minInterval) * easedProgress;
            
            await new Promise(resolve => setTimeout(resolve, currentInterval));
            resultMessage.classList.remove('shuffling');
        }
        
        // Select winners
        const shuffled = [...validParticipants].sort(() => Math.random() - 0.5);
        const winners = shuffled.slice(0, winnerCount);
        
        // Display winners in new format
        resultMessage.style.display = 'none';
        participantCount.style.display = 'none';
        resultDisplay.classList.add('has-winner');
        winnerAnnouncement.style.display = 'flex';
        
        if (winners.length === 1) {
            winnerBox.textContent = winners[0];
        } else {
            winnerBox.textContent = winners.join(', ');
        }
        
        // Show retry button, hide draw button
        drawButton.style.display = 'none';
        retryButton.style.display = 'flex';
        
        // Highlight winner inputs
        const inputs = document.querySelectorAll('.participant-input');
        inputs.forEach(input => {
            if (winners.includes(input.value.trim())) {
                input.classList.add('winner');
            }
        });
        
        isDrawing = false;
    }

    // Retry draw
    function retryDraw() {
        // Reset display
        resultDisplay.classList.remove('has-winner');
        winnerAnnouncement.style.display = 'none';
        resultMessage.style.display = 'block';
        participantCount.style.display = 'block';
        resultMessage.textContent = 'ì¶”ì²¨ì„ ì‹œì‘í•´ì£¼ì„¸ìš”';
        
        // Show draw button, hide retry button
        drawButton.style.display = 'flex';
        drawButton.disabled = false;
        retryButton.style.display = 'none';
        
        // Remove winner class from all inputs
        document.querySelectorAll('.participant-input').forEach(input => {
            input.classList.remove('winner');
        });
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    </script>
    </main>
</body>
</html>
